<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Bento Fit å¥åº·é¤ç›’</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8bc34a">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f1f8e9',
                            100: '#dcedc8',
                            400: '#9ccc65',
                            500: '#8bc34a', // Fresh Green
                            600: '#7cb342',
                            900: '#33691e',
                        },
                        dark: '#2c3e50',
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'float': '0 10px 30px -5px rgba(139, 195, 74, 0.2)',
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            background-color: #f9faf9;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom Checkbox */
        .custom-checkbox:checked + div {
            background-color: #8bc34a;
            border-color: #8bc34a;
        }
        .custom-checkbox:checked + div i {
            display: block;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
        }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e6e6e6 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="text-gray-700 font-sans antialiased h-screen flex flex-col overflow-hidden">

    <header class="bg-white/95 backdrop-blur-sm px-6 py-4 flex justify-between items-center sticky top-0 z-20 shadow-[0_1px_2px_rgba(0,0,0,0.02)]">
        <div>
            <h1 id="page-title" class="text-xl font-bold text-gray-800 tracking-tight">Bento Fit</h1>
            <p id="page-subtitle" class="text-[10px] text-gray-400 font-medium">ä»Šå¤©ä¹Ÿè¦åƒå¾—å¥åº·</p>
        </div>
        <div class="w-9 h-9 rounded-full bg-brand-50 flex items-center justify-center text-brand-600 cursor-pointer hover:bg-brand-100 transition" onclick="app.navigateTo('profile')">
            <i class="fa-solid fa-user text-sm"></i>
        </div>
    </header>

    <main id="main-container" class="flex-1 overflow-y-auto hide-scrollbar pb-24 px-4 pt-4 relative">
        
        <section id="view-dashboard" class="view-section fade-in hidden space-y-5">
            <div class="bg-white p-5 rounded-[24px] shadow-soft border border-gray-50">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-base font-bold text-gray-800">ä»Šæ—¥ç›®æ¨™</h2>
                    <button onclick="app.openReport()" class="text-[10px] bg-brand-100 text-brand-600 px-2 py-1 rounded-full font-bold hover:bg-brand-200 transition">
                        <i class="fa-solid fa-chart-pie mr-1"></i>é€±åˆ†æ
                    </button>
                    <span class="text-[10px] text-brand-600 bg-brand-50 px-2 py-1 rounded-full font-bold" id="tdee-display">TDEE: è¨ˆç®—ä¸­...</span>
                </div>
                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-medium text-gray-500">ç†±é‡ (Kcal)</span>
                            <span class="text-gray-800 font-bold"><span id="dash-cal-curr">0</span> <span class="text-gray-300 font-normal">/</span> <span id="dash-cal-target">0</span></span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                            <div id="bar-cal" class="bg-brand-400 h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-blue-50 p-2 rounded-xl text-center"><div class="text-[10px] text-blue-400 mb-1">è›‹ç™½è³ª</div><div class="h-1 w-full bg-blue-100 rounded-full"><div id="bar-prot" class="h-1 bg-blue-400 rounded-full" style="width:0%"></div></div></div>
                        <div class="bg-yellow-50 p-2 rounded-xl text-center"><div class="text-[10px] text-yellow-500 mb-1">ç¢³æ°´</div><div class="h-1 w-full bg-yellow-100 rounded-full"><div id="bar-carb" class="h-1 bg-yellow-400 rounded-full" style="width:0%"></div></div></div>
                        <div class="bg-red-50 p-2 rounded-xl text-center"><div class="text-[10px] text-red-400 mb-1">è„‚è‚ª</div><div class="h-1 w-full bg-red-100 rounded-full"><div id="bar-fat" class="h-1 bg-red-400 rounded-full" style="width:0%"></div></div></div>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-base font-bold text-gray-800 mb-3 ml-1">ä»Šæ—¥ä¾¿ç•¶</h3>
                <div id="today-meal-card" class="bg-white rounded-[24px] overflow-hidden shadow-soft cursor-pointer hover:scale-[1.01] transition-transform duration-300 group relative border border-gray-50">
                    <div class="p-8 text-center text-gray-400 italic">å°šæœªå®‰æ’</div>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="text-base font-bold text-gray-800 mb-3 ml-1 flex items-center gap-2">
                    <span>æ˜æ—¥å‚™é¤</span>
                    <span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full">æå‰æº–å‚™</span>
                </h3>
                <div id="tomorrow-meal-card" class="bg-white rounded-[24px] overflow-hidden shadow-soft cursor-pointer hover:scale-[1.01] transition-transform duration-300 group relative border border-orange-100/50">
                    </div>
            </div>
            <button onclick="app.navigateTo('planner')" class="w-full bg-white border border-brand-100 text-brand-600 font-bold py-3.5 rounded-2xl hover:bg-brand-50 transition active:scale-95 text-sm flex items-center justify-center gap-2 shadow-sm">
                <i class="fa-solid fa-calendar-plus"></i> è¦åŠƒä¸‹é€±ä¾¿ç•¶
            </button>
        </section>

        <section id="view-planner" class="view-section fade-in hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-4 ml-1">æœ¬é€±èœå–®</h2>
            
            <button onclick="app.generateAIPlan()" class="w-full mb-6 bg-brand-500 text-white p-4 rounded-2xl shadow-float flex items-center justify-center gap-2 transform active:scale-95 transition-all hover:bg-brand-600">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span class="font-bold">AI æ™ºæ…§ç”Ÿæˆæœ¬é€±èœå–®</span>
            </button>

            <div id="ai-loading" class="hidden space-y-4">
                <div class="flex flex-col items-center justify-center gap-2 text-brand-500 font-medium py-4">
                    <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
                    <span class="text-sm">AI æ­£åœ¨èª¿é…ç‡Ÿé¤Šé£Ÿè­œ...</span>
                </div>
                <div class="bg-white p-4 rounded-2xl h-20 w-full shimmer"></div>
                <div class="bg-white p-4 rounded-2xl h-20 w-full shimmer"></div>
            </div>

            <div class="space-y-3" id="planner-list"></div>
        </section>

        <section id="view-shopping" class="view-section fade-in hidden h-full flex flex-col">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 mb-4 sticky top-0 z-10">
                <div class="flex justify-between items-end mb-2">
                    <div class="text-xs text-gray-400 font-bold uppercase tracking-wider">æ¡è²·å®Œæˆåº¦</div>
                    </div>
                <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden shadow-inner">
                    <div id="shop-progress-bar" class="h-full bg-brand-500 transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="flex justify-end gap-3 mb-2 px-1">
                <button onclick="app.copyShoppingList()" class="text-xs text-brand-500 font-bold hover:text-brand-600 flex items-center gap-1"><i class="fa-regular fa-copy"></i> è¤‡è£½æ¸…å–®</button>
                <button onclick="app.clearShoppingList()" class="text-xs text-red-400 font-bold hover:text-red-500 flex items-center gap-1"><i class="fa-regular fa-trash-can"></i> æ¸…é™¤å·²è²·</button>
            </div>
            <button onclick="app.filterStaples()" class="text-xs text-gray-400 font-bold hover:text-gray-600 flex items-center gap-1">
                <i class="fa-solid fa-filter"></i> éš±è—å¸¸å‚™å“
            </button>
            
            <div id="shopping-list-container" class="space-y-8 pb-32"></div>
        </section>
        
        <section id="view-history" class="view-section fade-in hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-4 ml-1">æ­·å²ç´€éŒ„</h2>
            <div id="history-list" class="space-y-4"></div>
            <div id="history-empty" class="hidden text-center text-gray-400 py-10"><p class="text-sm">æš«ç„¡ç´€éŒ„</p></div>
        </section>

        <section id="view-profile" class="view-section fade-in hidden">
            <div class="bg-white p-6 rounded-[24px] shadow-soft mb-6">
                <h2 class="text-lg font-bold text-gray-800 mb-6 text-center">å€‹äººè¨­å®š</h2>

                <form id="profile-form" class="space-y-5" onsubmit="event.preventDefault(); app.saveProfile();">
                    
                    <h3 class="text-xs font-bold text-gray-400 border-l-4 border-brand-500 pl-2">åŸºæœ¬è³‡æ–™</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">èº«é«˜ (cm)</label>
                            <input type="number" id="input-height" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brand-400 transition" placeholder="160" required enterkeyhint="next">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">é«”é‡ (kg)</label>
                            <input type="number" id="input-weight" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brand-400 transition" placeholder="50" required enterkeyhint="next">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">å¹´é½¡</label>
                            <input type="number" id="input-age" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brand-400 transition" placeholder="25" required enterkeyhint="next">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">æ€§åˆ¥</label>
                            <select id="input-gender" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brand-400 transition">
                                <option value="male">ç”·æ€§</option>
                                <option value="female">å¥³æ€§</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1">æ—¥å¸¸æ´»å‹•é‡</label>
                        <select id="input-activity" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brand-400 transition">
                            <option value="1.2">ä¹…åä¸å‹• (è¾¦å…¬å®¤å·¥ä½œ)</option>
                            <option value="1.375">è¼•åº¦æ´»å‹• (æ¯é€±é‹å‹•1-3å¤©)</option>
                            <option value="1.55">ä¸­åº¦æ´»å‹• (æ¯é€±é‹å‹•3-5å¤©)</option>
                            <option value="1.725">é«˜åº¦æ´»å‹• (æ¯é€±é‹å‹•6-7å¤©)</option>
                            <option value="1.9">è¶…é«˜åº¦æ´»å‹• (å‹åŠ›å·¥ä½œ/é‹å‹•å“¡)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1">é£²é£Ÿç›®æ¨™ (AI åƒè€ƒç”¨)</label>
                        <select id="input-goal" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brand-400 transition">
                            <option value="å‡è¡¡é£²é£Ÿ">ğŸ¥— å‡è¡¡é£²é£Ÿ (ç¶­æŒå¥åº·)</option>
                            <option value="å¢è‚Œé«˜è›‹ç™½">ğŸ’ª å¢è‚Œ (é«˜è›‹ç™½/ä¸­ç¢³æ°´)</option>
                            <option value="æ¸›è„‚ä½ç¢³">ğŸ”¥ æ¸›è„‚ (ä½ç¢³æ°´/é«˜çº–)</option>
                            <option value="ä½GIé£²é£Ÿ">ğŸ“‰ ä½GI (ç©©å®šè¡€ç³–)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1">æ’é™¤é£Ÿæ / éæ•åŸ (AI é¿é–‹)</label>
                        <textarea id="input-exclude" rows="2" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-red-200 transition" placeholder="ä¾‹å¦‚ï¼šé¦™èœã€è¦å­ã€é’æ¤’..." enterkeyhint="next"></textarea>
                    </div>
                    <h3 class="text-xs font-bold text-gray-400 border-l-4 border-blue-400 pl-2 mt-2">èº«é«”çµ„æˆ (é«”è„‚è¨ˆæ•¸æ“š)</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">é«”è„‚ç‡ (%)</label>
                            <input type="number" step="0.1" id="input-bf" class="w-full bg-blue-50/50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-300 transition" placeholder="é¸å¡«"  enterkeyhint="next">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">è‚Œè‚‰é‡ (kg)</label>
                            <input type="number" step="0.1" id="input-muscle" class="w-full bg-blue-50/50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-300 transition" placeholder="é¸å¡«" enterkeyhint="next">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">å…§è‡Ÿè„‚è‚ªç­‰ç´š</label>
                            <input type="number" step="0.5" id="input-vfat" class="w-full bg-blue-50/50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-300 transition" placeholder="é¸å¡«" enterkeyhint="next">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">åŸºç¤ä»£è¬ (é«”è„‚è¨ˆ)</label>
                            <input type="number" id="input-scale-bmr" class="w-full bg-blue-50/50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-300 transition" placeholder="é¸å¡«" enterkeyhint="next">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">æ°´åˆ†å«é‡ (%)</label>
                            <input type="number" step="0.1" id="input-water" class="w-full bg-blue-50/50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-300 transition" placeholder="é¸å¡«" enterkeyhint="next">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">è›‹ç™½è³ª (%)</label>
                            <input type="number" step="0.1" id="input-protein" class="w-full bg-blue-50/50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-300 transition" placeholder="é¸å¡«" enterkeyhint="next">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">éª¨é‡ (kg)</label>
                            <input type="number" step="0.1" id="input-bone" class="w-full bg-blue-50/50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-300 transition" placeholder="é¸å¡«" enterkeyhint="next">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">BMI (é¸å¡«)</label>
                            <input type="number" step="0.1" id="input-bmi" class="w-full bg-blue-50/50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-300 transition" placeholder="è‡ªå‹•è¨ˆç®—" enterkeyhint="next">
                        </div>
                    </div>

                    <div class="pt-2">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1">GEMINI API KEY (AI åŠŸèƒ½å¿…å¡«)</label>
                        <input type="password" id="input-apikey" class="w-full bg-gray-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brand-400 transition" placeholder="AIzaSy..." enterkeyhint="next">
                    </div>
                    
                    <button type="submit" class="w-full bg-brand-500 text-white font-bold py-4 rounded-xl shadow-float active:scale-95 transition-transform hover:bg-brand-600">å„²å­˜å€‹äººèˆ‡èº«é«”æ•¸å€¼</button>
                </form>
                <div id="chart-container" class="bg-white p-4 rounded-[24px] shadow-sm border border-gray-100 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-line text-brand-500"></i> é«”é‡è¶¨å‹¢
                        </h3>
                        <span class="text-[10px] text-gray-400 bg-gray-50 px-2 py-1 rounded-full">æœ€è¿‘ 30 ç­†</span>
                    </div>
                    <svg id="body-chart-svg" viewBox="0 0 300 120" class="w-full h-32 text-brand-500" style="min-height: 150px;">
                        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#ccc" font-size="12">å„²å­˜ 2 ç­†ä»¥ä¸Šè³‡æ–™å¾Œé¡¯ç¤º</text>
                    </svg>
                </div>
            </div>
            <div class="bg-white p-6 rounded-[24px] shadow-soft mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">æˆå°±èˆ‡æŒ‘æˆ°</h2>
                    <span class="text-xs bg-orange-100 text-orange-600 px-3 py-1 rounded-full font-bold">ğŸ”¥ é€£çºŒ <span id="streak-count">0</span> å¤©</span>
                </div>
                <div id="badge-container" class="grid grid-cols-4 gap-2">
                    </div>
            </div>
            <div class="flex gap-3 mb-8">
                <button onclick="app.exportData()" class="flex-1 bg-white border border-gray-200 text-gray-600 font-bold py-3 rounded-xl text-xs hover:bg-gray-50"><i class="fa-solid fa-download mr-1"></i> å‚™ä»½</button>
                <label class="flex-1 bg-white border border-gray-200 text-gray-600 font-bold py-3 rounded-xl text-xs hover:bg-gray-50 flex items-center justify-center cursor-pointer"><i class="fa-solid fa-upload mr-1"></i> åŒ¯å…¥<input type="file" class="hidden" onchange="app.importData(this)"></label>
            </div>
            <div class="text-center"><button onclick="app.resetData()" class="text-xs text-red-300 hover:text-red-500 underline">é‡ç½®æ‰€æœ‰è³‡æ–™</button></div>
        </section>
    </main>

    <nav class="bg-white px-6 pb-6 pt-2 shadow-[0_-5px_30px_rgba(0,0,0,0.03)] z-30 w-full rounded-t-[30px] fixed bottom-0 safe-pb">
        <ul class="flex justify-between items-center">
            <li class="nav-item w-full" onclick="app.navigateTo('dashboard')"><div class="flex flex-col items-center gap-1 group cursor-pointer text-brand-500 py-2" id="nav-dashboard"><i class="fa-solid fa-house text-xl mb-0.5 transition-transform group-active:scale-90"></i><span class="text-[10px] font-medium">é¦–é </span></div></li>
            <li class="nav-item w-full" onclick="app.navigateTo('planner')"><div class="flex flex-col items-center gap-1 group cursor-pointer text-gray-300 py-2" id="nav-planner"><i class="fa-solid fa-calendar-days text-xl mb-0.5 transition-transform group-active:scale-90"></i><span class="text-[10px] font-medium">è¦åŠƒ</span></div></li>
            <li class="nav-item w-full" onclick="app.navigateTo('shopping')"><div class="flex flex-col items-center gap-1 group cursor-pointer text-gray-300 py-2" id="nav-shopping"><i class="fa-solid fa-list-check text-xl mb-0.5 transition-transform group-active:scale-90"></i><span class="text-[10px] font-medium">æ¸…å–®</span></div></li>
            <li class="nav-item w-full" onclick="app.navigateTo('history')"><div class="flex flex-col items-center gap-1 group cursor-pointer text-gray-300 py-2" id="nav-history"><i class="fa-solid fa-clock-rotate-left text-xl mb-0.5 transition-transform group-active:scale-90"></i><span class="text-[10px] font-medium">ç´€éŒ„</span></div></li>
        </ul>
    </nav>

        <div id="modal-selector" class="fixed inset-0 z-50 hidden modal-backdrop flex items-end sm:items-center sm:justify-center">
            <div class="bg-white w-full h-[80vh] sm:h-[600px] sm:w-[450px] rounded-t-[30px] sm:rounded-[30px] flex flex-col shadow-2xl animate-slide-up">
                
                <div class="p-5 border-b border-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-gray-800">é¸æ“‡èœè‰²</h3>
                    <button onclick="app.closeModal('modal-selector')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400"><i class="fa-solid fa-times"></i></button>
                </div>
                
                <div class="px-5 py-3 flex gap-2 overflow-x-auto hide-scrollbar">
                    <button onclick="app.filterRecipes('fav')" class="filter-chip px-4 py-1.5 bg-pink-50 text-pink-500 rounded-full text-xs font-bold whitespace-nowrap shadow-sm border border-pink-100">
                        <i class="fa-solid fa-heart mr-1"></i>æ”¶è—
                    </button>
                    <button onclick="app.filterRecipes('all')" class="filter-chip px-4 py-1.5 bg-brand-500 text-white rounded-full text-xs font-bold whitespace-nowrap shadow-sm">
                        å…¨éƒ¨
                    </button>
                </div>

                <div id="selector-list" class="flex-1 overflow-y-auto p-5 space-y-3"></div>
            </div>
        </div>

        <div id="modal-detail" class="fixed inset-0 z-50 hidden modal-backdrop flex items-end sm:items-center sm:justify-center">
            <div class="bg-white w-full h-[70vh] sm:h-[600px] sm:w-[450px] rounded-t-[30px] sm:rounded-[30px] flex flex-col shadow-2xl overflow-hidden">
                
                <div class="relative h-32 bg-brand-500 flex items-center justify-center flex-col p-6 text-center">
                    
                    <button onclick="app.closeModal('modal-detail')" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center hover:bg-white/30"><i class="fa-solid fa-times"></i></button>
                    
                    <button id="btn-fav-toggle" class="absolute top-4 right-16 w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center hover:bg-white/30 transition active:scale-90">
                        <i class="fa-regular fa-heart"></i>
                    </button>

                    <h2 id="detail-title" class="text-2xl font-bold text-white tracking-wide mb-1"></h2>
                    <span id="detail-cal" class="bg-white/20 px-3 py-1 rounded-full text-xs text-white font-medium"></span>
                </div>

                <div class="flex-1 overflow-y-auto p-6 pb-10">
                    <div class="flex justify-between bg-gray-50 p-4 rounded-2xl mb-6 text-center">
                        <div><div class="text-[10px] text-gray-400 mb-1">è›‹ç™½è³ª</div><div id="detail-p" class="font-bold text-gray-800 text-sm"></div></div>
                        <div class="w-px bg-gray-200"></div>
                        <div><div class="text-[10px] text-gray-400 mb-1">ç¢³æ°´</div><div id="detail-c" class="font-bold text-gray-800 text-sm"></div></div>
                        <div class="w-px bg-gray-200"></div>
                        <div><div class="text-[10px] text-gray-400 mb-1">è„‚è‚ª</div><div id="detail-f" class="font-bold text-gray-800 text-sm"></div></div>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-3 text-sm flex items-center gap-2"><i class="fa-solid fa-basket-shopping text-brand-400"></i> é£Ÿæ</h3>
                    <ul id="detail-ingredients" class="list-disc list-inside text-gray-600 space-y-1 mb-6 text-sm pl-2 marker:text-gray-300"></ul>
                    <h3 class="font-bold text-gray-800 mb-3 text-sm flex items-center gap-2"><i class="fa-solid fa-list-ol text-brand-400"></i> æ­¥é©Ÿ</h3>
                    <p id="detail-instructions" class="text-gray-600 text-sm leading-7 bg-gray-50 p-4 rounded-2xl"></p>
                </div>
            </div>
        </div>

    <div id="modal-history" class="fixed inset-0 z-50 hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[24px] flex flex-col shadow-2xl max-h-[70vh]">
            <div id="history-header" class="p-4 border-b border-gray-50 flex justify-between items-center"></div>
            <div id="history-content" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        </div>
    </div>

    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-gray-800/90 backdrop-blur text-white px-5 py-2.5 rounded-full shadow-lg opacity-0 pointer-events-none transition-all duration-300 z-[70] text-xs font-bold flex items-center gap-2">
        <i class="fa-solid fa-check text-brand-400"></i> <span id="toast-msg"></span>
    </div>
    <div id="modal-cooking" class="fixed inset-0 z-[100] hidden bg-gray-900 text-white flex flex-col transition-opacity duration-300">
        <div class="p-6 flex justify-between items-center">
            <button onclick="app.exitCooking()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white/80 hover:bg-white/20"><i class="fa-solid fa-xmark"></i></button>
            <div class="text-xs font-mono text-brand-400 border border-brand-400 px-3 py-1 rounded-full">Cooking Mode</div>
            <div class="w-10"></div> </div>

        <div class="flex-1 flex flex-col justify-center items-center px-8 text-center" onclick="app.nextCookingStep()">
            <h2 id="cook-step-num" class="text-6xl font-bold text-brand-500 mb-8 opacity-20">01</h2>
            <p id="cook-step-text" class="text-2xl font-bold leading-relaxed tracking-wide">è¼‰å…¥ä¸­...</p>
            <p class="text-gray-500 text-sm mt-8 animate-pulse">é»æ“Šç•«é¢é€²å…¥ä¸‹ä¸€æ­¥</p>
        </div>

        <div class="p-8 pb-12 safe-pb">
            <div class="flex justify-between items-center mb-4 px-2">
                <button onclick="app.prevCookingStep(event)" class="text-gray-400 hover:text-white p-2"><i class="fa-solid fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
                <span id="cook-progress-text" class="text-xs text-gray-500 font-mono">1 / 5</span>
            </div>
            <div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden">
                <div id="cook-progress-bar" class="h-full bg-brand-500 transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>
    <div id="modal-report" class="fixed inset-0 z-50 hidden modal-backdrop flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full h-[85vh] sm:h-[650px] sm:w-[450px] rounded-t-[30px] sm:rounded-[30px] flex flex-col shadow-2xl animate-slide-up">
            
            <div class="p-6 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                <div>
                    <h3 class="font-bold text-xl text-gray-800">é€±ç‡Ÿé¤Šåˆ†æ</h3>
                    <p class="text-xs text-gray-400 mt-1">æœ¬é€±èœå–® (Mon-Fri) ç¸½è¦½</p>
                </div>
                <button onclick="app.closeModal('modal-report')" class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                
                <div class="text-center">
                    <h4 class="text-sm font-bold text-gray-600 mb-4 flex items-center justify-center gap-2"><i class="fa-solid fa-chart-pie text-brand-500"></i> ç‡Ÿé¤Šç´ æ¯”ä¾‹ (P/C/F)</h4>
                    <div class="relative w-48 h-48 mx-auto">
                        <svg id="chart-macro-pie" viewBox="0 0 100 100" class="w-full h-full transform -rotate-90"></svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-xs text-gray-400">ç¸½ç†±é‡</span>
                            <span id="report-total-cal" class="text-lg font-bold text-gray-800">0</span>
                            <span class="text-[10px] text-gray-400">Avg. Kcal</span>
                        </div>
                    </div>
                    <div class="flex justify-center gap-4 mt-4 text-xs">
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> è›‹ç™½è³ª <span id="val-p" class="font-bold">0%</span></div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> ç¢³æ°´ <span id="val-c" class="font-bold">0%</span></div>
                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-400"></span> è„‚è‚ª <span id="val-f" class="font-bold">0%</span></div>
                    </div>
                </div>

                <div>
                    <h4 class="text-sm font-bold text-gray-600 mb-4 flex items-center gap-2"><i class="fa-solid fa-chart-column text-brand-500"></i> æ¯æ—¥ç†±é‡åˆ†ä½ˆ</h4>
                    <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100">
                        <svg id="chart-cal-bar" viewBox="0 0 300 100" class="w-full h-32"></svg>
                    </div>
                </div>

                <div class="bg-brand-50 rounded-2xl p-4 border border-brand-100">
                    <h4 class="text-sm font-bold text-brand-700 mb-2"><i class="fa-solid fa-robot mr-1"></i> AI ç‡Ÿé¤ŠçŸ­è©•</h4>
                    <p id="report-comment" class="text-xs text-brand-800 leading-relaxed">åˆ†æä¸­...</p>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-ai-options" class="fixed inset-0 z-50 hidden modal-backdrop flex items-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:w-[400px] rounded-t-[30px] sm:rounded-[30px] p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-gray-800">AI èœå–®è¨­å®š</h3>
                <button onclick="app.closeModal('modal-ai-options')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2"><i class="fa-solid fa-earth-asia"></i> æ–™ç†é¢¨æ ¼</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="ai-cuisine" value="å‡è¡¡å¥åº·" class="peer hidden" checked>
                            <div class="py-2 text-xs font-bold text-center rounded-xl bg-gray-50 text-gray-400 peer-checked:bg-brand-100 peer-checked:text-brand-600 border border-transparent peer-checked:border-brand-200 transition">ğŸ¥— å‡è¡¡</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="ai-cuisine" value="å°å¼å®¶å¸¸" class="peer hidden">
                            <div class="py-2 text-xs font-bold text-center rounded-xl bg-gray-50 text-gray-400 peer-checked:bg-brand-100 peer-checked:text-brand-600 border border-transparent peer-checked:border-brand-200 transition">ğŸ‡¹ğŸ‡¼ å°å¼</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="ai-cuisine" value="æ—¥å¼å®šé£Ÿ" class="peer hidden">
                            <div class="py-2 text-xs font-bold text-center rounded-xl bg-gray-50 text-gray-400 peer-checked:bg-brand-100 peer-checked:text-brand-600 border border-transparent peer-checked:border-brand-200 transition">ğŸ‡¯ğŸ‡µ æ—¥å¼</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="ai-cuisine" value="éŸ“å¼é¢¨å‘³" class="peer hidden">
                            <div class="py-2 text-xs font-bold text-center rounded-xl bg-gray-50 text-gray-400 peer-checked:bg-brand-100 peer-checked:text-brand-600 border border-transparent peer-checked:border-brand-200 transition">ğŸ‡°ğŸ‡· éŸ“å¼</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="ai-cuisine" value="è¥¿å¼åœ°ä¸­æµ·" class="peer hidden">
                            <div class="py-2 text-xs font-bold text-center rounded-xl bg-gray-50 text-gray-400 peer-checked:bg-brand-100 peer-checked:text-brand-600 border border-transparent peer-checked:border-brand-200 transition">ğŸ‡®ğŸ‡¹ è¥¿å¼</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="ai-cuisine" value="å—æ´‹æ³°å¼" class="peer hidden">
                            <div class="py-2 text-xs font-bold text-center rounded-xl bg-gray-50 text-gray-400 peer-checked:bg-brand-100 peer-checked:text-brand-600 border border-transparent peer-checked:border-brand-200 transition">ğŸ‡¹ğŸ‡­ æ³°å¼</div>
                        </label>
                    </div>
                </div>

                <label class="flex items-center gap-3 p-3 bg-orange-50 rounded-xl cursor-pointer border border-orange-100">
                    <input type="checkbox" id="ai-opt-batch" class="w-5 h-5 text-orange-500 rounded focus:ring-orange-400 border-gray-300">
                    <div class="flex-1">
                        <div class="text-sm font-bold text-gray-800">é–‹å•Ÿã€Œæ‡¶äººå‚™é¤ã€æ¨¡å¼</div>
                        <div class="text-[10px] text-gray-500">5 å¤©åªç…® 2-3 é“èœé‡è¤‡åƒï¼Œçœæ™‚çœåŠ›</div>
                    </div>
                    <i class="fa-solid fa-repeat text-orange-300"></i>
                </label>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1">æ¸…å†°ç®± (å„ªå…ˆç”¨)</label>
                        <input type="text" id="ai-opt-fridge" class="w-full bg-gray-50 border border-gray-100 rounded-xl px-3 py-2 text-xs outline-none focus:border-brand-300" >
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-red-300 mb-1">æ’é™¤é£Ÿæ</label>
                        <input type="text" id="ai-opt-exclude" class="w-full bg-red-50 border border-red-100 rounded-xl px-3 py-2 text-xs outline-none focus:border-red-300">
                    </div>
                </div>
                
                <button onclick="app.confirmAIPlan()" class="w-full bg-brand-500 text-white font-bold py-3.5 rounded-2xl shadow-float active:scale-95 transition-transform">
                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> ç”Ÿæˆæœ¬é€±èœå–®
                </button>
            </div>
        </div>
    </div>

    <div id="modal-rating" class="fixed inset-0 z-[60] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[24px] p-6 shadow-2xl flex flex-col items-center animate-slide-up">
            <h3 class="text-lg font-bold text-gray-800 mb-1">ä»Šå¤©çš„ä¾¿ç•¶å¥½åƒå—ï¼Ÿ</h3>
            <p class="text-xs text-gray-400 mb-6">æ‚¨çš„å›é¥‹å°‡è®“ AI ä¸‹æ¬¡æ›´æ‡‚æ‚¨çš„èƒƒå£</p>
            
            <div class="flex gap-2 mb-6" id="star-container">
                <button id="star-1" onclick="app.previewRating(1)" class="w-10 h-10 rounded-full bg-gray-50 text-gray-300 text-xl transition"><i class="fa-solid fa-star"></i></button>
                <button id="star-2" onclick="app.previewRating(2)" class="w-10 h-10 rounded-full bg-gray-50 text-gray-300 text-xl transition"><i class="fa-solid fa-star"></i></button>
                <button id="star-3" onclick="app.previewRating(3)" class="w-10 h-10 rounded-full bg-gray-50 text-gray-300 text-xl transition"><i class="fa-solid fa-star"></i></button>
                <button id="star-4" onclick="app.previewRating(4)" class="w-10 h-10 rounded-full bg-gray-50 text-gray-300 text-xl transition"><i class="fa-solid fa-star"></i></button>
                <button id="star-5" onclick="app.previewRating(5)" class="w-10 h-10 rounded-full bg-gray-50 text-gray-300 text-xl transition"><i class="fa-solid fa-star"></i></button>
            </div>
            
            <button id="btn-submit-rating" onclick="app.confirmRating()" class="w-full bg-brand-500 text-white font-bold py-3 rounded-xl shadow-float mb-3 hidden">é€å‡ºè©•åˆ†</button>
            <button onclick="app.closeModal('modal-rating')" class="text-xs text-gray-400 underline">ç•¥é</button>
        </div>
    </div>
    <div id="modal-general" class="fixed inset-0 z-[80] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[24px] p-6 shadow-2xl flex flex-col items-center animate-slide-up transform transition-all">
            <div id="modal-icon-bg" class="w-16 h-16 rounded-full bg-brand-50 text-brand-500 flex items-center justify-center mb-4 text-2xl shadow-sm">
                <i id="modal-icon" class="fa-solid fa-circle-question"></i>
            </div>
            
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-2">ç¢ºèª</h3>
            <p id="modal-msg" class="text-sm text-gray-500 text-center mb-8 leading-relaxed px-2"></p>
            
            <div class="flex gap-3 w-full">
                <button id="modal-btn-cancel" class="flex-1 bg-gray-50 text-gray-400 font-bold py-3.5 rounded-2xl hover:bg-gray-100 transition active:scale-95">å–æ¶ˆ</button>
                <button id="modal-btn-confirm" class="flex-1 bg-brand-500 text-white font-bold py-3.5 rounded-2xl shadow-float hover:bg-brand-600 transition active:scale-95">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    <script>
        // MOCK DATA
        let recipes = [
            { id: 1, name: "æ—¥å¼é¹½çƒ¤é¯–é­š", cal: 420, p: 25, c: 5, f: 30, tags: ["é­š"], ingredients: ["é¯–é­šç‰‡", "ç™½è˜¿è””", "æª¸æª¬"], instructions: "1. é¯–é­šæŠ¹é¹½éœç½®ã€‚\n2. ä¹¾ç…è‡³å…©é¢é‡‘é»ƒã€‚\n3. æ­é…è˜¿è””æ³¥é£Ÿç”¨ã€‚" },
            { id: 2, name: "è”¥çˆ†ç‰›è‚‰ä¾¿ç•¶", cal: 480, p: 30, c: 45, f: 20, tags: ["ç‰›"], ingredients: ["ç‰›è‚‰ç‰‡", "é’è”¥", "æ´‹è”¥", "é†¬æ²¹"], instructions: "1. çˆ†é¦™è”¥æ®µã€‚\n2. ä¸‹ç‰›è‚‰å¤§ç«å¿«ç‚’ã€‚\n3. åŠ å…¥èª¿å‘³å¿«é€Ÿèµ·é‹ã€‚" },
            { id: 3, name: "é®®è¦é…ªæ¢¨æ²™æ‹‰", cal: 350, p: 25, c: 15, f: 22, tags: ["æµ·é®®","è¼•é£Ÿ"], ingredients: ["é®®è¦", "é…ªæ¢¨", "ç”Ÿèœ", "ç•ªèŒ„"], instructions: "1. è¦ä»ç‡™ç†Ÿå†·å»ã€‚\n2. é…ªæ¢¨åˆ‡å¡Šã€‚\n3. æ·‹ä¸Šæ²¹é†‹é†¬æ‹Œå‹»ã€‚" },
            { id: 4, name: "ç…§ç‡’é›è…¿æ’", cal: 500, p: 35, c: 40, f: 25, tags: ["é›è‚‰"], ingredients: ["å»éª¨é›è…¿", "ç…§ç‡’é†¬", "èŠ±æ¤°èœ"], instructions: "1. é›è…¿æ’çš®æœä¸‹ç…ã€‚\n2. å€’å…¥é†¬æ±æ”¶ä¹¾ã€‚\n3. åˆ‡å¡Šæ“ºç›¤ã€‚" },
            { id: 5, name: "æ¸…ç‚’æ™‚è”¬è±†è…", cal: 320, p: 18, c: 20, f: 15, tags: ["ç´ "], ingredients: ["æ¿è±†è…", "é¦™è‡", "ç´…è˜¿è””", "è·è˜­è±†"], instructions: "1. è±†è…åˆ‡ç‰‡ç…é»ƒã€‚\n2. åŠ å…¥è”¬èœæ‹Œç‚’ã€‚\n3. é¹½å·´èª¿å‘³å³å¯ã€‚" }
        ];

        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
        const dayLabels = { 'Mon': 'é€±ä¸€', 'Tue': 'é€±äºŒ', 'Wed': 'é€±ä¸‰', 'Thu': 'é€±å››', 'Fri': 'é€±äº”' };

        const app = {
            state: { user: null, plan: { Mon: null, Tue: null, Wed: null, Thu: null, Fri: null }, shopping: {}, history: [] },

        // --- [å„ªåŒ–ç‰ˆ] app.init (åŠ å…¥ safeParse é˜²å‘†æ©Ÿåˆ¶) ---
        init: () => {
            const ls = localStorage;

            // ğŸ›¡ï¸ å®šç¾©å®‰å…¨è§£æ Helper (é˜²æ­¢ JSON æ ¼å¼éŒ¯èª¤å°è‡´ç•¶æ©Ÿ)
            const safeParse = (key, defaultVal) => {
                try {
                    const item = ls.getItem(key);
                    // å¦‚æœæœ‰è³‡æ–™å‰‡è§£æï¼Œæ²’è³‡æ–™å‰‡å›å‚³é è¨­å€¼
                    return item ? JSON.parse(item) : defaultVal;
                } catch (e) {
                    console.warn(`âš ï¸ è¼‰å…¥ ${key} å¤±æ•— (è³‡æ–™å¯èƒ½ææ¯€)ï¼Œå·²é‡ç½®ç‚ºé è¨­å€¼ã€‚`, e);
                    // è‹¥è§£æå¤±æ•— (ä¾‹å¦‚ JSON æ ¼å¼å£æ‰)ï¼Œç›´æ¥å›å‚³é è¨­å€¼ï¼Œè®“ App èƒ½ç¹¼çºŒé‹ä½œ
                    return defaultVal;
                }
            };

            // 1. è®€å–åŸæœ‰è³‡æ–™ (å…¨éƒ¨æ”¹ç”¨ safeParse)
            app.state.user = safeParse('bento_user', null);
            
            app.state.plan = safeParse('bento_plan', { Mon: null, Tue: null, Wed: null, Thu: null, Fri: null });
            
            app.state.shopping = safeParse('bento_shopping', {});
            
            // recipes æ˜¯å…¨åŸŸè®Šæ•¸ï¼Œè‹¥è®€å–å¤±æ•—å‰‡ä½¿ç”¨é è¨­çš„ç¤ºç¯„è³‡æ–™
            recipes = safeParse('bento_recipes', [
                { id: 1, name: "æ—¥å¼é¹½çƒ¤é¯–é­š", cal: 420, p: 25, c: 5, f: 30, tags: ["é­š"], ingredients: ["é¯–é­šç‰‡", "ç™½è˜¿è””", "æª¸æª¬"], instructions: "1. é¯–é­šæŠ¹é¹½éœç½®ã€‚\n2. ä¹¾ç…è‡³å…©é¢é‡‘é»ƒã€‚\n3. æ­é…è˜¿è””æ³¥é£Ÿç”¨ã€‚" },
                { id: 2, name: "è”¥çˆ†ç‰›è‚‰ä¾¿ç•¶", cal: 480, p: 30, c: 45, f: 20, tags: ["ç‰›"], ingredients: ["ç‰›è‚‰ç‰‡", "é’è”¥", "æ´‹è”¥", "é†¬æ²¹"], instructions: "1. çˆ†é¦™è”¥æ®µã€‚\n2. ä¸‹ç‰›è‚‰å¤§ç«å¿«ç‚’ã€‚\n3. åŠ å…¥èª¿å‘³å¿«é€Ÿèµ·é‹ã€‚" },
                { id: 3, name: "é®®è¦é…ªæ¢¨æ²™æ‹‰", cal: 350, p: 25, c: 15, f: 22, tags: ["æµ·é®®","è¼•é£Ÿ"], ingredients: ["é®®è¦", "é…ªæ¢¨", "ç”Ÿèœ", "ç•ªèŒ„"], instructions: "1. è¦ä»ç‡™ç†Ÿå†·å»ã€‚\n2. é…ªæ¢¨åˆ‡å¡Šã€‚\n3. æ·‹ä¸Šæ²¹é†‹é†¬æ‹Œå‹»ã€‚" },
                { id: 4, name: "ç…§ç‡’é›è…¿æ’", cal: 500, p: 35, c: 40, f: 25, tags: ["é›è‚‰"], ingredients: ["å»éª¨é›è…¿", "ç…§ç‡’é†¬", "èŠ±æ¤°èœ"], instructions: "1. é›è…¿æ’çš®æœä¸‹ç…ã€‚\n2. å€’å…¥é†¬æ±æ”¶ä¹¾ã€‚\n3. åˆ‡å¡Šæ“ºç›¤ã€‚" },
                { id: 5, name: "æ¸…ç‚’æ™‚è”¬è±†è…", cal: 320, p: 18, c: 20, f: 15, tags: ["ç´ "], ingredients: ["æ¿è±†è…", "é¦™è‡", "ç´…è˜¿è””", "è·è˜­è±†"], instructions: "1. è±†è…åˆ‡ç‰‡ç…é»ƒã€‚\n2. åŠ å…¥è”¬èœæ‹Œç‚’ã€‚\n3. é¹½å·´èª¿å‘³å³å¯ã€‚" }
            ]);

            app.state.history = safeParse('bento_history', []);
            app.state.prep = safeParse('bento_prep', {});
            app.state.ratings = safeParse('bento_ratings', {});
            app.state.bodyLog = safeParse('bento_body_log', []);
            
            // éŠæˆ²åŒ–æ•¸æ“š (Streak/Badges)
            app.state.game = safeParse('bento_game', { streak: 0, lastLogin: '', badges: [] });

            // 2. é£²æ°´åˆå§‹åŒ– (è·¨æ—¥é‡ç½®é‚è¼¯)
            const today = new Date().toLocaleDateString('zh-TW');
            const lastDate = ls.getItem('bento_last_date');
            
            if (lastDate !== today) {
                app.state.water = 0;
                localStorage.setItem('bento_water', 0);
                localStorage.setItem('bento_last_date', today);
            } else {
                // æ°´é‡ä¹Ÿè¦è½‰å‹é˜²å‘†
                const savedWater = ls.getItem('bento_water');
                app.state.water = savedWater ? parseInt(savedWater) : 0;
            }

            // 3. åŸ·è¡Œæª¢æŸ¥ (é€£çºŒç™»å…¥èˆ‡å¾½ç« )
            app.checkStreak(today);
            app.checkBadges();

            // 4. å°èˆªé‚è¼¯
            if (!app.state.user) {
                app.navigateTo('profile');
                document.querySelector('nav').classList.add('hidden');
            } else {
                app.navigateTo('dashboard');
            }
            
            // 5. å„ªåŒ–éµç›¤é«”é©— (æŒ‰ Enter è‡ªå‹•è·³ä¸‹ä¸€æ ¼)
            document.querySelectorAll('input').forEach((input, index, inputs) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextInput = inputs[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        } else {
                            input.blur();
                            if(input.id === 'input-apikey') app.saveProfile();
                        }
                    }
                });
            });
        },
        // --- è«‹æ›¿æ› app ç‰©ä»¶ä¸­çš„ renderDashboard å‡½å¼ ---

        renderDashboard: () => {
            const u = app.state.user;
            if(!u) return;
            
            const tdee = u.tdee || 2000;
            const lunchTarget = Math.round(tdee * 0.35);
            const waterTarget = 2000; // é è¨­ç›®æ¨™ 2000ml
            const currentWater = app.state.water || 0;
            
            // 1. æ›´æ–° TDEE æ–‡å­—
            document.getElementById('tdee-display').innerText = `TDEE: ${tdee}`;
            document.getElementById('dash-cal-target').innerText = lunchTarget;

            // 2. èº«é«”æ•¸å€¼å¡ç‰‡ (ç¶­æŒæ‚¨åŸæœ¬çš„é‚è¼¯)
            let statsContainer = document.getElementById('dash-body-stats');
            const dashboardCard = document.querySelector('#view-dashboard > div:first-child');
            
            if (!statsContainer && dashboardCard) {
                statsContainer = document.createElement('div');
                statsContainer.id = 'dash-body-stats';
                statsContainer.className = "mt-4 pt-4 border-t border-gray-100 grid grid-cols-4 gap-2";
                dashboardCard.querySelector('.space-y-3').appendChild(statsContainer);
            }

            if (statsContainer && u.bodyComp) {
                const bc = u.bodyComp;
                const stats = [
                    { label: 'BMI', val: bc.bmi, unit: '', color: 'text-gray-600' },
                    { label: 'é«”è„‚ç‡', val: bc.bf, unit: '%', color: 'text-blue-500' },
                    { label: 'è‚Œè‚‰é‡', val: bc.muscle, unit: 'kg', color: 'text-indigo-500' },
                    { label: 'å…§è‡Ÿè„‚', val: bc.vfat, unit: '', color: 'text-red-400' }
                ].filter(s => s.val);

                if (stats.length > 0) {
                    statsContainer.innerHTML = stats.map(s => `
                        <div class="text-center">
                            <div class="text-[9px] text-gray-400 mb-0.5">${s.label}</div>
                            <div class="text-xs font-bold ${s.color}">${s.val}<span class="text-[9px] scale-75 ml-0.5">${s.unit}</span></div>
                        </div>
                    `).join('');
                    statsContainer.classList.remove('hidden');
                } else {
                    statsContainer.classList.add('hidden');
                }
            }

            // 3. é£²æ°´è¿½è¹¤å¡ç‰‡ (æ’å…¥åœ¨ã€Œä»Šæ—¥ç›®æ¨™ã€èˆ‡ã€Œä»Šæ—¥ä¾¿ç•¶ã€ä¹‹é–“)
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“å­˜åœ¨ï¼Œä¸å­˜åœ¨å‰‡å»ºç«‹
            let waterCard = document.getElementById('dash-water-card');
            if (!waterCard) {
                waterCard = document.createElement('div');
                waterCard.id = 'dash-water-card';
                // æ’å…¥åœ¨ dashboardCard (ä»Šæ—¥ç›®æ¨™) çš„å¾Œé¢
                dashboardCard.parentNode.insertBefore(waterCard, dashboardCard.nextSibling);
            }

            // æ¸²æŸ“é£²æ°´å¡ç‰‡å…§å®¹
            waterCard.className = "bg-blue-50/50 p-4 rounded-[24px] border border-blue-100 flex justify-between items-center";
            waterCard.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center">
                        <i class="fa-solid fa-glass-water text-lg"></i>
                    </div>
                    <div>
                        <div class="text-xs text-blue-400 font-bold mb-0.5">æ¯æ—¥é£²æ°´</div>
                        <div class="text-sm font-bold text-gray-700">${currentWater} <span class="text-xs text-gray-400 font-normal">/ ${waterTarget}ml</span></div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.updateWater(-250)" class="w-8 h-8 rounded-full bg-white text-blue-300 hover:text-blue-500 shadow-sm flex items-center justify-center transition active:scale-95"><i class="fa-solid fa-minus"></i></button>
                    <button onclick="app.updateWater(250)" class="w-8 h-8 rounded-full bg-blue-500 text-white shadow-float hover:bg-blue-600 flex items-center justify-center transition active:scale-95"><i class="fa-solid fa-plus"></i></button>
                </div>
            `;

            // 4. æ—¥æœŸèˆ‡ä¾¿ç•¶é‚è¼¯ (ç¶­æŒä¸è®Š)
            const dayMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const todayIndex = new Date().getDay(); 
            const tomorrowIndex = (todayIndex + 1) % 7; 
            const todayKey = dayMap[todayIndex];
            const tomorrowKey = dayMap[tomorrowIndex];

            const rid = app.state.plan[todayKey];
            const r = recipes.find(x => x.id === rid);

            if(r) {
                document.getElementById('dash-cal-curr').innerText = r.cal;
                document.getElementById('bar-cal').style.width = Math.min((r.cal/lunchTarget)*100, 100) + '%';
                document.getElementById('bar-prot').style.width = Math.min((r.p/40)*100, 100) + '%'; 
                document.getElementById('bar-carb').style.width = Math.min((r.c/60)*100, 100) + '%'; 
                document.getElementById('bar-fat').style.width = Math.min((r.f/25)*100, 100) + '%'; 

                // 1. æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²è©•åˆ†
                const todayStr = new Date().toLocaleDateString('zh-TW');
                const myRating = app.state.ratings ? app.state.ratings[todayStr] : 0;
                
                // 2. æ±ºå®šè©•åˆ†æŒ‰éˆ•çš„æ¨£å¼ (é»ƒè‰²å¯¦å¿ƒ vs ç°è‰²ç©ºå¿ƒ)
                let ratingBtnHtml = '';
                if (myRating) {
                    // å·²è©•åˆ†ï¼šé¡¯ç¤ºé»ƒè‰²æ˜Ÿæ˜Ÿèˆ‡åˆ†æ•¸
                    ratingBtnHtml = `
                        <button onclick="app.openRating('${todayKey}')" class="text-[10px] font-bold text-yellow-500 bg-yellow-50 border border-yellow-100 px-2 py-1 rounded-full transition" ${event ? 'onclick="event.stopPropagation(); app.openRating(\''+todayKey+'\')"' : ''}>
                            <i class="fa-solid fa-star"></i> ${myRating} åˆ†
                        </button>
                    `;
                } else {
                    // æœªè©•åˆ†ï¼šé¡¯ç¤ºç°è‰²ã€Œè©•åˆ†ã€æŒ‰éˆ•
                    ratingBtnHtml = `
                        <button onclick="app.openRating('${todayKey}')" class="text-[10px] font-bold text-gray-400 hover:text-yellow-500 flex items-center gap-1 border border-gray-100 px-2 py-1 rounded-full transition bg-white" ${event ? 'onclick="event.stopPropagation(); app.openRating(\''+todayKey+'\')"' : ''}>
                            <i class="fa-regular fa-star"></i> è©•åˆ†
                        </button>
                    `;
                }

                // 3. æ¸²æŸ“å¡ç‰‡ (æ³¨æ„ï¼šåŸæœ¬çš„ button æ¨™ç±¤å·²æ›¿æ›ç‚º ${ratingBtnHtml})
                document.getElementById('today-meal-card').innerHTML = `
                        <div class="flex items-center gap-4 p-4 text-left">
                            <div class="w-20 h-20 rounded-xl bg-brand-100 flex items-center justify-center text-brand-500 shrink-0">
                                <i class="fa-solid fa-bowl-food text-3xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800 text-lg line-clamp-1">${r.name}</h3>
                                <div class="text-xs text-gray-500 mt-1">ğŸ”¥ ${r.cal} Kcal Â· P${r.p} C${r.c} F${r.f}</div>
                                <div class="flex justify-between items-end mt-2">
                                    <div class="flex gap-1">
                                        ${r.tags.map(t => `<span class="text-[10px] bg-brand-50 text-brand-600 px-2 py-0.5 rounded-full">${t}</span>`).join('')}
                                    </div>
                                    ${ratingBtnHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    // ç‚ºäº†è®“é»æ“Šå¡ç‰‡ä»èƒ½çœ‹è©³æƒ…ï¼Œæˆ‘å€‘è¦æŠŠè©•åˆ†æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶ç¨ç«‹å‡ºä¾†
                    // (æ³¨æ„ï¼šä¸Šé¢çš„ onclick å·²ç¶“è™•ç†äº†ï¼Œé€™è£¡åªéœ€è¦ç¢ºä¿å¤–å±¤ click ä¸æœƒè¡çª)
                    const card = document.getElementById('today-meal-card');
                    card.onclick = (e) => {
                        // å¦‚æœé»åˆ°çš„æ˜¯æŒ‰éˆ•ï¼Œå°±ä¸é–‹è©³æƒ…
                        if(e.target.closest('button')) return;
                        app.openDetailById(r.id);
                    };
            } else {
                document.getElementById('dash-cal-curr').innerText = "0";
                document.getElementById('bar-cal').style.width = '0%';
                document.getElementById('bar-prot').style.width = '0%';
                document.getElementById('bar-carb').style.width = '0%';
                document.getElementById('bar-fat').style.width = '0%';
                document.getElementById('today-meal-card').innerHTML = `<div class="p-8 text-center text-gray-400 italic">ä»Šæ—¥ä¼‘æ¯æˆ–æ˜¯é€±æœ«</div>`;
            }

            // æ˜æ—¥å‚™é¤é‚è¼¯ (ç¶­æŒä¸è®Š)
            const nextRid = app.state.plan[tomorrowKey];
            const nextR = recipes.find(x => x.id === nextRid);
            const tomorrowCard = document.getElementById('tomorrow-meal-card');
            const isPrepped = app.state.prep && app.state.prep[tomorrowKey];

            if(nextR) {
                tomorrowCard.onclick = () => app.openDetailById(nextR.id);
                const cardBgClass = isPrepped ? "bg-green-50/50 border-green-200" : "bg-orange-50/30 border-orange-100/50";
                const iconBgClass = isPrepped ? "bg-green-100 text-green-500" : "bg-orange-100 text-orange-500";
                const iconClass = isPrepped ? "fa-check" : "fa-fire-burner";
                const btnText = isPrepped ? "å·²å‚™æ–™" : "å‚™æ–™ç¢ºèª";
                const btnStyle = isPrepped 
                    ? "bg-green-500 text-white border-green-500" 
                    : "bg-white text-gray-400 border-gray-200 hover:border-orange-300 hover:text-orange-500";

                tomorrowCard.className = `bg-white rounded-[24px] overflow-hidden shadow-soft cursor-pointer hover:scale-[1.01] transition-all duration-300 group relative border ${cardBgClass}`;
                tomorrowCard.innerHTML = `
                    <div class="flex items-center gap-4 p-4 text-left">
                        <div class="w-20 h-20 rounded-xl ${iconBgClass} flex items-center justify-center shrink-0 transition-colors duration-300">
                            <i class="fa-solid ${iconClass} text-3xl"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-gray-800 text-lg line-clamp-1 ${isPrepped ? 'text-green-700' : ''}">${nextR.name}</h3>
                            <div class="text-xs text-gray-500 mt-1 mb-2">
                                ${isPrepped ? '<span class="text-green-600 font-bold"><i class="fa-solid fa-check-circle"></i> æº–å‚™å°±ç·’</span>' : 'æ˜æ—¥é å‚™é£Ÿæï¼š'}
                            </div>
                            <div class="flex flex-wrap gap-1 ${isPrepped ? 'opacity-50' : ''}">
                                ${nextR.ingredients.slice(0, 2).map(ing => {
                                    const ingName = (typeof ing === 'string') ? ing.split(' ')[0] : ing.name;
                                    return `<span class="text-[10px] bg-white border border-gray-100 text-gray-600 px-2 py-0.5 rounded-md">${ingName}</span>`;
                                }).join('')}
                            </div>
                        </div>
                        <button onclick="app.togglePrep('${tomorrowKey}', event)" class="absolute bottom-4 right-4 z-10 text-[10px] font-bold px-3 py-1.5 rounded-full border shadow-sm transition-all active:scale-95 flex items-center gap-1 ${btnStyle}">
                            <i class="fa-solid ${isPrepped ? 'fa-check' : 'fa-clipboard-check'}"></i> ${btnText}
                        </button>
                    </div>
                `;
            } else {
                tomorrowCard.onclick = null;
                tomorrowCard.className = "bg-white rounded-[24px] overflow-hidden shadow-soft border border-gray-50";
                tomorrowCard.innerHTML = `
                    <div class="p-6 text-center text-gray-400 flex flex-col items-center gap-2">
                        <i class="fa-regular fa-face-smile text-2xl text-gray-300"></i>
                        <span class="text-xs">æ˜æ—¥ç„¡è¨ˆç•«ï¼Œä¸ç”¨å‚™é¤</span>
                    </div>
                `;
            }
        },
        // --- è«‹æ–°å¢é€™äº›å‡½å¼åˆ° app ç‰©ä»¶ä¸­ ---

        // --- è©•åˆ†é‚è¼¯å¤§å‡ç´š ---

        openRating: (dayKey) => {
            app.state.ratingDay = dayKey; 
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“è©•åˆ†éï¼Œè‹¥æœ‰å‰‡é å…ˆé¡¯ç¤ºæ˜Ÿæ˜Ÿ
            const todayStr = new Date().toLocaleDateString('zh-TW');
            const savedRating = app.state.ratings[todayStr] || 0;
            
            app.updateStarVisuals(savedRating);
            app.state.tempRating = savedRating; // æš«å­˜ä½¿ç”¨è€…ç¾åœ¨é»é¸çš„åˆ†æ•¸
            
            // å¦‚æœé‚„æ²’è©•åˆ†ï¼Œéš±è—é€å‡ºæŒ‰éˆ•ï¼›å·²è©•åˆ†å‰‡é¡¯ç¤º
            const btn = document.getElementById('btn-submit-rating');
            if(savedRating > 0) {
                btn.innerText = "æ›´æ–°è©•åˆ†";
                btn.classList.remove('hidden');
            } else {
                btn.innerText = "é€å‡ºè©•åˆ†";
                btn.classList.add('hidden');
            }

            document.getElementById('modal-rating').classList.remove('hidden');
        },

        // ä½¿ç”¨è€…é»æ“Šæ˜Ÿæ˜Ÿæ™‚çš„é è¦½æ•ˆæœ (é€£å‹• 1~N é¡†æ˜Ÿ)
        previewRating: (score) => {
            app.state.tempRating = score;
            app.updateStarVisuals(score);
            
            // é¡¯ç¤ºé€å‡ºæŒ‰éˆ•
            const btn = document.getElementById('btn-submit-rating');
            btn.classList.remove('hidden');
        },

        // æ›´æ–°æ˜Ÿæ˜Ÿé¡è‰²çš„ UI é‚è¼¯
        updateStarVisuals: (score) => {
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`star-${i}`);
                if (i <= score) {
                    // äº®èµ·ï¼šé»ƒè‰²ã€èƒŒæ™¯å¾®é»ƒ
                    btn.className = "w-10 h-10 rounded-full bg-yellow-50 text-yellow-400 text-xl transition transform scale-110";
                } else {
                    // ç†„æ»…ï¼šç°è‰²
                    btn.className = "w-10 h-10 rounded-full bg-gray-50 text-gray-300 text-xl transition";
                }
            }
        },

        // æŒ‰ä¸‹ã€Œé€å‡ºã€æ‰çœŸæ­£å„²å­˜
        confirmRating: () => {
            const score = app.state.tempRating;
            if (!score) return;
            app.submitRating(score);
        },

        submitRating: (score) => {
            app.closeModal('modal-rating');
            const day = app.state.ratingDay;
            const rid = app.state.plan[day];
            const r = recipes.find(x => x.id === rid);

            if (!r) return;

            // 1. å„²å­˜è©•åˆ†ç´€éŒ„ (é€™æ˜¯æœ€é—œéµçš„æ•¸æ“š)
            const todayStr = new Date().toLocaleDateString('zh-TW');
            if(!app.state.ratings) app.state.ratings = {}; // é˜²å‘†åˆå§‹åŒ–
            app.state.ratings[todayStr] = score;
            localStorage.setItem('bento_ratings', JSON.stringify(app.state.ratings));

            // 2. æ”¶è—é‚è¼¯ä¿®æ­£ (åŒ…å«è‡ªå‹•ç§»é™¤)
            if (score >= 4) {
                // --- é«˜åˆ†ï¼šè‡ªå‹•åŠ å…¥æ”¶è— ---
                if (!r.favorite) {
                    r.favorite = true;
                    app.showToast(`â­ å·²è©• ${score} æ˜Ÿä¸¦åŠ å…¥æ”¶è—ï¼`);
                } else {
                    app.showToast(`â­ æ„Ÿè¬æ‚¨çš„ ${score} æ˜Ÿå¥½è©•ï¼`);
                }
            } else {
                // --- ä½åˆ† (3åˆ†ä»¥ä¸‹)ï¼šè‹¥åŸæœ¬æ˜¯æ”¶è—ï¼Œè‡ªå‹•ç§»é™¤ ---
                if (r.favorite) {
                    r.favorite = false;
                    app.showToast(`ğŸ’” è©•åˆ†é™ç‚º ${score} æ˜Ÿï¼Œå·²å¾æ”¶è—ç§»é™¤`);
                } else {
                    app.showToast(`âœ… è©•åˆ†å·²æ›´æ–°ç‚º ${score} æ˜Ÿ`);
                }
            }
            // å­˜æª”é£Ÿè­œç‹€æ…‹ (æ”¶è—è®Šæ›´)
            localStorage.setItem('bento_recipes', JSON.stringify(recipes));

            // ğŸ”¥ é—œéµä¿®æ­£ï¼šåœ¨é€™è£¡å°±ç›´æ¥å¼·åˆ¶æ¸²æŸ“ç•«é¢ (å„ªå…ˆç´šæå‡)
            // é€™æ¨£å¯ä»¥ç¢ºä¿æŒ‰éˆ•é¡è‰²ç«‹åˆ»è®Šæ›´ï¼Œä¸æœƒè¢«å¾Œé¢çš„é‚è¼¯å»¶èª¤
            app.renderDashboard();

            // 3. æ’é™¤é‚è¼¯ (2åˆ†ä»¥ä¸‹ï¼ŒåŠ å…¥é»‘åå–®)
            // (é€™æ®µé‚è¼¯è¼ƒè¤‡é›œï¼Œæ”¾åœ¨æ¸²æŸ“ç•«é¢ä¹‹å¾ŒåŸ·è¡Œï¼Œé¿å…å¡ä½ UI)
            if (score <= 2) {
                try {
                    const user = app.state.user;
                    const newExclude = r.name.split('ä½')[0]; // ç°¡å–®æŠ“ä¸»èœå
                    
                    if (!user.exclude.includes(newExclude)) {
                        user.exclude = user.exclude ? `${user.exclude}ã€${newExclude}` : newExclude;
                        app.state.user = user;
                        localStorage.setItem('bento_user', JSON.stringify(user));
                        
                        const inputEx = document.getElementById('input-exclude');
                        if(inputEx) inputEx.value = user.exclude;
                        
                        setTimeout(() => app.showToast(`ğŸ“‰ å°‡æ¸›å°‘æ¨è–¦ã€Œ${newExclude}ã€é¡èœè‰²`), 1000);
                    }
                } catch(e) {
                    console.log("æ’é™¤é‚è¼¯åŸ·è¡Œè¼•å¾®éŒ¯èª¤ (ä¸å½±éŸ¿è©•åˆ†):", e);
                }
            }
            
            // 4. åŒæ­¥æ›´æ–°è©³æƒ…é çš„æ„›å¿ƒ (å¦‚æœä½¿ç”¨è€…æ˜¯åœ¨è©³æƒ…é é»è©•åˆ†çš„è©±)
            const favBtn = document.getElementById('btn-fav-toggle');
            const detailModal = document.getElementById('modal-detail');
            if(favBtn && detailModal && !detailModal.classList.contains('hidden')) {
                if(r.favorite) {
                    favBtn.innerHTML = '<i class="fa-solid fa-heart text-red-500 text-lg"></i>';
                    favBtn.classList.remove('bg-white/20');
                    favBtn.classList.add('bg-white');
                } else {
                    favBtn.innerHTML = '<i class="fa-regular fa-heart text-white"></i>';
                    favBtn.classList.add('bg-white/20');
                    favBtn.classList.remove('bg-white');
                }
            }
        },
        // --- è«‹æ›¿æ› app.startCooking å‡½å¼ ---
        startCooking: async (id) => {
            const r = recipes.find(x => x.id === id);
            if(!r || !r.instructions) return app.showToast('æ­¤é£Ÿè­œæ²’æœ‰æ­¥é©Ÿ');

            // âœ… ä¿®æ­£ï¼šä½¿ç”¨èˆ‡ openDetail ç›¸åŒçš„è§£æé‚è¼¯
            let raw = r.instructions;
            raw = raw.replace(/\\n/g, '\n');
            if (!raw.includes('\n') && raw.match(/\d+\./)) {
                raw = raw.replace(/(\d+\.)/g, '\n$1');
            }
            const steps = raw.split('\n').map(s => s.trim()).filter(s => s.length > 0);

            // 1. åˆå§‹åŒ–æ•¸æ“š
            app.cookingState = {
                steps: steps,
                current: 0
            };

            // 2. å˜—è©¦é–‹å•Ÿè¢å¹•æ†äº® (Wake Lock)
            try {
                if ('wakeLock' in navigator) {
                    app.wakeLock = await navigator.wakeLock.request('screen');
                    console.log('è¢å¹•æ†äº®å·²é–‹å•Ÿ');
                }
            } catch (err) {
                console.log('Wake Lock å¤±æ•—:', err);
            }

            // 3. é¡¯ç¤º UI
            document.getElementById('modal-cooking').classList.remove('hidden');
            app.renderCookingStep();
        },
        renderCookingStep: () => {
            const s = app.cookingState;
            const total = s.steps.length;
            
            // æ›´æ–°æ–‡å­—
            document.getElementById('cook-step-num').innerText = (s.current + 1).toString().padStart(2, '0');
            document.getElementById('cook-step-text').innerText = s.steps[s.current];
            document.getElementById('cook-progress-text').innerText = `${s.current + 1} / ${total}`;
            
            // æ›´æ–°é€²åº¦æ¢
            const pct = ((s.current + 1) / total) * 100;
            document.getElementById('cook-progress-bar').style.width = `${pct}%`;
        },

        nextCookingStep: async () => { // âš ï¸ è¨˜å¾—åŠ  async
            const s = app.cookingState;
            if (s.current < s.steps.length - 1) {
                s.current++;
                app.renderCookingStep();
            } else {
                // âœ… ä¿®æ”¹è™•ï¼šæœ€å¾Œä¸€æ­¥çš„ç¢ºèª
                if(await app.showModal('æ­å–œå®Œæˆï¼è¦çµæŸçƒ¹é£ªæ¨¡å¼å—ï¼Ÿ', "æ–™ç†å®Œæˆ", "confirm")) {
                    app.exitCooking();
                    app.showToast('ğŸ‰ æ–™ç†å®Œæˆï¼è¨˜å¾—æ‹ç…§æ‰“å¡å–”');
                }
            }
        },

        prevCookingStep: (e) => {
            if(e) e.stopPropagation(); // é¿å…è§¸ç™¼ nextCookingStep
            const s = app.cookingState;
            if (s.current > 0) {
                s.current--;
                app.renderCookingStep();
            }
        },

        exitCooking: () => {
            // é‡‹æ”¾ Wake Lock
            if (app.wakeLock) {
                app.wakeLock.release().then(() => app.wakeLock = null);
            }
            document.getElementById('modal-cooking').classList.add('hidden');
        },
            // æª¢æŸ¥é€£çºŒç™»å…¥
            checkStreak: (today) => {
                const game = app.state.game;
                const lastLogin = game.lastLogin;
                
                if (lastLogin !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toLocaleDateString('zh-TW');

                    if (lastLogin === yesterdayStr) {
                        game.streak += 1; // é€£çºŒç™»å…¥
                    } else {
                        game.streak = 1; // ä¸­æ–·æˆ–ç¬¬ä¸€å¤©
                    }
                    game.lastLogin = today;
                    localStorage.setItem('bento_game', JSON.stringify(game));
                }
                
                // æ›´æ–° Profile é é¢é¡¯ç¤º
                const streakEl = document.getElementById('streak-count');
                if(streakEl) streakEl.innerText = game.streak;
            },

            // æª¢æŸ¥ä¸¦æ¸²æŸ“å¾½ç« 
            checkBadges: () => {
                const game = app.state.game;
                const user = app.state.user;
                const history = app.state.history || [];
                const bodyLog = app.state.bodyLog || [];

                // å®šç¾©æ‰€æœ‰å¾½ç«  (å·²æ›´æ–°é›£åº¦æ¢ä»¶)
                const allBadges = [
                    // æ–°æ‰‹ä¸Šè·¯ï¼šæ¢ä»¶ä¸è®Š (åªè¦é–‹å•Ÿ App)
                    { id: 'newbie', icon: 'fa-seedling', name: 'æ–°æ‰‹ä¸Šè·¯', color: 'text-green-500', bg: 'bg-green-100', cond: () => true },
                    
                    // è¦åŠƒé”äººï¼šæ¢ä»¶æ”¹ç‚ºæ­·å²ç´€éŒ„ >= 10 ç­†
                    { id: 'planner', icon: 'fa-calendar-check', name: 'è¦åŠƒé”äºº', color: 'text-blue-500', bg: 'bg-blue-100', cond: () => history.length >= 10 },
                    
                    // ç†±åº¦ç‡ƒç‡’ï¼šæ¢ä»¶æ”¹ç‚ºé€£çºŒç™»å…¥ >= 30 å¤©
                    { id: 'streak3', icon: 'fa-fire', name: 'ç†±åº¦ç‡ƒç‡’', color: 'text-orange-500', bg: 'bg-orange-100', cond: () => game.streak >= 30 },
                    
                    // æ•¸æ“šæ§ï¼šæ¢ä»¶æ”¹ç‚ºèº«é«”ç´€éŒ„ >= 10 ç­†
                    { id: 'tracker', icon: 'fa-weight-scale', name: 'æ•¸æ“šæ§', color: 'text-purple-500', bg: 'bg-purple-100', cond: () => bodyLog.length >= 10 }
                ];

                // æª¢æŸ¥è§£é– (ä»¥ä¸‹é‚è¼¯ä¸è®Š)
                let newUnlock = false;
                allBadges.forEach(b => {
                    if (!game.badges.includes(b.id) && b.cond()) {
                        game.badges.push(b.id);
                        newUnlock = true;
                        app.showToast(`ğŸ† è§£é–æˆå°±ï¼š${b.name}`);
                    }
                });
                if(newUnlock) localStorage.setItem('bento_game', JSON.stringify(game));

                // æ¸²æŸ“ Profile å¾½ç« åˆ—è¡¨ (å¢åŠ æœªè§£é–æ™‚çš„æç¤º tooltip æˆ–æ˜¯ç°è‰²ç‹€æ…‹)
                const container = document.getElementById('badge-container');
                if(container) {
                    container.innerHTML = allBadges.map(b => {
                        const unlocked = game.badges.includes(b.id);
                        // é€™è£¡å¯ä»¥ç¨å¾®å„ªåŒ– UIï¼Œæœªè§£é–æ™‚é¡¯ç¤ºç°è‰²
                        return `
                            <div class="flex flex-col items-center gap-1 p-2 rounded-xl ${unlocked ? b.bg : 'bg-gray-50 opacity-40 grayscale'} transition-all relative group" title="${unlocked ? 'å·²è§£é–' : 'å°šæœªé”æˆ'}">
                                <i class="fa-solid ${b.icon} text-xl ${unlocked ? b.color : 'text-gray-400'}"></i>
                                <span class="text-[9px] font-bold text-gray-600">${b.name}</span>
                            </div>
                        `;
                    }).join('');
                }
            },
            // --- è«‹æ–°å¢æ­¤å‡½å¼åˆ° app ç‰©ä»¶ä¸­ ---
            updateWater: (amount) => {
                let current = app.state.water || 0;
                let newAmount = current + amount;
                if(newAmount < 0) newAmount = 0; // ä¸èƒ½å°æ–¼ 0
                
                app.state.water = newAmount;
                localStorage.setItem('bento_water', newAmount);
                app.renderDashboard(); // é‡æ–°æ¸²æŸ“ç•«é¢ä»¥æ›´æ–°æ•¸å€¼
            },
            // --- æ–°å¢ï¼šåˆ‡æ›å‚™æ–™ç‹€æ…‹ ---
            togglePrep: (dayKey, event) => {
                // é˜»æ­¢å†’æ³¡ï¼Œé¿å…è§¸ç™¼å¡ç‰‡çš„ onclick (é€²å…¥è©³æƒ…é )
                if(event) event.stopPropagation();
                
                // åˆ‡æ›ç‹€æ…‹
                app.state.prep[dayKey] = !app.state.prep[dayKey];
                
                // å­˜æª”
                localStorage.setItem('bento_prep', JSON.stringify(app.state.prep));
                
                // é‡æ–°æ¸²æŸ“ç•«é¢ (æ›´æ–°æŒ‰éˆ•æ¨£å¼)
                app.renderDashboard();
                
                // ç°¡å–®çš„å›é¥‹
                if(app.state.prep[dayKey]) {
                    app.showToast('âœ… å·²å®Œæˆæ˜æ—¥å‚™æ–™');
                }
            },
            navigateTo: (pageId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-item > div').forEach(el => {
                    el.classList.remove('text-brand-500');
                    el.classList.add('text-gray-300');
                });
                document.getElementById(`view-${pageId}`).classList.remove('hidden');
                
                if (pageId !== 'profile') {
                    document.querySelector('nav').classList.remove('hidden');
                    const navEl = document.getElementById(`nav-${pageId}`);
                    if(navEl) {
                        navEl.classList.add('text-brand-500');
                        navEl.classList.remove('text-gray-300');
                    }
                }
                
                window.scrollTo(0,0);
                if(pageId === 'dashboard') app.renderDashboard();
                if(pageId === 'planner') app.renderPlanner();
                if(pageId === 'shopping') app.renderShopping();
                if(pageId === 'history') app.renderHistory();
                if(pageId === 'profile' && app.state.user) app.fillProfile();
            },

        // --- è«‹æ›¿æ› app ç‰©ä»¶ä¸­çš„ saveProfile å‡½å¼ ---

        saveProfile: () => {
            // 1. ç²å–åŸºæœ¬æ¬„ä½
            const h = parseFloat(document.getElementById('input-height').value);
            const w = parseFloat(document.getElementById('input-weight').value);
            const age = parseInt(document.getElementById('input-age').value);
            const gender = document.getElementById('input-gender').value;
            const activity = parseFloat(document.getElementById('input-activity').value);
            const goal = document.getElementById('input-goal').value;
            const key = document.getElementById('input-apikey').value.trim();
            const exclude = document.getElementById('input-exclude').value.trim();
            if (!h || !w || !age) return app.showToast('è«‹å¡«å¯«åŸºæœ¬èº«é«˜é«”é‡è³‡æ–™');

            // 2. ç²å–èº«é«”çµ„æˆæ¬„ä½
            const bf = parseFloat(document.getElementById('input-bf').value);
            const muscle = parseFloat(document.getElementById('input-muscle').value);
            const vfat = parseFloat(document.getElementById('input-vfat').value);
            const water = parseFloat(document.getElementById('input-water').value);
            const protein = parseFloat(document.getElementById('input-protein').value);
            const bone = parseFloat(document.getElementById('input-bone').value);
            const scaleBmr = parseFloat(document.getElementById('input-scale-bmr').value);
            let bmi = parseFloat(document.getElementById('input-bmi').value);

            if (!bmi && h && w) bmi = (w / ((h / 100) * (h / 100))).toFixed(1);

            // 3. è¨ˆç®— BMR èˆ‡ TDEE
            let bmr = 0;
            if (bf > 0) {
                const lbm = w * (1 - (bf / 100));
                bmr = 370 + (21.6 * lbm);
            } else if (scaleBmr > 0) {
                bmr = scaleBmr;
            } else {
                if (gender === 'male') bmr = (10 * w) + (6.25 * h) - (5 * age) + 5;
                else bmr = (10 * w) + (6.25 * h) - (5 * age) - 161;
            }

            const tdee = Math.round(bmr * activity);

            // 4. æ›´æ–° User State
            app.state.user = {
                height: h, weight: w, age: age, gender: gender, activity: activity,
                goal: goal, tdee: tdee, apiKey: key,
                exclude: exclude, // å„²å­˜æ’é™¤é£Ÿæ
                bodyComp: { bmi, bf: bf||null, muscle: muscle||null, vfat: vfat||null, water: water||null, protein: protein||null, bone: bone||null, scaleBmr: scaleBmr||null }
            };
            localStorage.setItem('bento_user', JSON.stringify(app.state.user));

            // 5. âœ… æ–°å¢ï¼šè‡ªå‹•è¨˜éŒ„é«”æ…‹è¶¨å‹¢ (Body Log)
            const todayDate = new Date().toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' }); // ä¾‹å¦‚ "1/15"
            
            // æª¢æŸ¥ä»Šå¤©æ˜¯å¦å·²ç¶“è¨˜éŒ„é (é¿å…é‡è¤‡)
            const existingIndex = app.state.bodyLog.findIndex(log => log.date === todayDate);
            const logEntry = { date: todayDate, weight: w, bf: bf || 0 };

            if (existingIndex >= 0) {
                app.state.bodyLog[existingIndex] = logEntry; // æ›´æ–°ä»Šå¤©çš„
            } else {
                app.state.bodyLog.push(logEntry); // æ–°å¢
                // åªä¿ç•™æœ€è¿‘ 30 ç­†ï¼Œé¿å…è³‡æ–™éå¤š
                if (app.state.bodyLog.length > 30) app.state.bodyLog.shift();
            }
            localStorage.setItem('bento_body_log', JSON.stringify(app.state.bodyLog));
            
            // é‡æ–°ç¹ªè£½åœ–è¡¨
            app.renderBodyChart();

            app.showToast(`è¨­å®šå·²å„²å­˜ï¼ç›®æ¨™ï¼š${goal}`);
            
            // ğŸ”´ ä¿®æ­£é‡é»ï¼šå„²å­˜æˆåŠŸå¾Œï¼Œå¼·åˆ¶é¡¯ç¤ºå°è¦½åˆ—ä¸¦è·³è½‰é¦–é 
            document.querySelector('nav').classList.remove('hidden');
            app.navigateTo('dashboard');
        },
        // --- è«‹æ›¿æ› app ç‰©ä»¶ä¸­çš„ fillProfile å‡½å¼ ---

        fillProfile: () => {
            const u = app.state.user;
            if (!u) return;

            document.getElementById('input-height').value = u.height || '';
            document.getElementById('input-weight').value = u.weight || '';
            document.getElementById('input-age').value = u.age || '';
            document.getElementById('input-gender').value = u.gender || 'male';
            document.getElementById('input-activity').value = u.activity || '1.2';
            document.getElementById('input-goal').value = u.goal || 'å‡è¡¡é£²é£Ÿ';
            document.getElementById('input-exclude').value = u.exclude || '';
            if (u.apiKey) document.getElementById('input-apikey').value = u.apiKey;

            if (u.bodyComp) {
                document.getElementById('input-bf').value = u.bodyComp.bf || '';
                document.getElementById('input-muscle').value = u.bodyComp.muscle || '';
                document.getElementById('input-vfat').value = u.bodyComp.vfat || '';
                document.getElementById('input-water').value = u.bodyComp.water || '';
                document.getElementById('input-protein').value = u.bodyComp.protein || '';
                document.getElementById('input-bone').value = u.bodyComp.bone || '';
                document.getElementById('input-scale-bmr').value = u.bodyComp.scaleBmr || '';
                document.getElementById('input-bmi').value = u.bodyComp.bmi || '';
            }

            // âœ… æ–°å¢ï¼šé€²å…¥é é¢æ™‚ç¹ªè£½åœ–è¡¨
            app.renderBodyChart();
        },
        // --- è«‹æ–°å¢æ­¤å‡½å¼åˆ° app ç‰©ä»¶ä¸­ ---

        renderBodyChart: () => {
            const container = document.getElementById('body-chart-svg');
            if (!container) return;
            
            const logs = app.state.bodyLog || [];
            container.innerHTML = ''; // æ¸…ç©ºå…§å®¹

            if (logs.length === 0) {
                container.innerHTML = `<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#ccc" font-size="12">å°šç„¡æ•¸æ“š</text>`;
                return;
            }

            // å°ºå¯¸è¨­å®š (é…åˆ HTML æ”¹ç‚º 120)
            const width = 300;
            const height = 120;
            const padding = 20;

            // 1. è¨ˆç®—æ•¸å€¼ç¯„åœ
            const weights = logs.map(l => Number(l.weight)); // ç¢ºä¿æ˜¯æ•¸å­—
            let minW = Math.min(...weights);
            let maxW = Math.max(...weights);
            
            // é˜²å‘†ï¼šå¦‚æœæœ€å¤§æœ€å°å€¼ä¸€æ¨£ (ä¾‹å¦‚åªæœ‰ä¸€ç­†è³‡æ–™ï¼Œæˆ–é«”é‡æ²’è®Š)ï¼Œæ‰‹å‹•çµ¦ä¸€å€‹ç¯„åœï¼Œé¿å…é™¤ä»¥ 0
            if (minW === maxW) {
                minW -= 2;
                maxW += 2;
            }
            const rangeW = maxW - minW;

            // 2. è¨ˆç®—åº§æ¨™é»
            const points = logs.map((log, i) => {
                // å¦‚æœåªæœ‰ 1 ç­†è³‡æ–™ï¼Œå°±ç•«åœ¨æ­£ä¸­é–“ï¼›å¦å‰‡ä¾æ¯”ä¾‹åˆ†å¸ƒ
                const x = logs.length === 1 
                    ? width / 2 
                    : padding + (i / (logs.length - 1)) * (width - padding * 2);
                    
                // æ•¸å€¼è¶Šé«˜ï¼Œy åº§æ¨™è¶Šå° (è¶Šä¸Šé¢)
                const y = height - padding - ((log.weight - minW) / rangeW) * (height - padding * 2);
                
                return { x, y, val: log.weight, date: log.date };
            });

            // 3. çµ„åˆ SVG å…§å®¹
            let svgHTML = `
                <defs>
                    <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#8bc34a;stop-opacity:0.2" />
                        <stop offset="100%" style="stop-color:#8bc34a;stop-opacity:0" />
                    </linearGradient>
                </defs>
            `;

            // åªæœ‰ 2 ç­†ä»¥ä¸Šè³‡æ–™æ‰ç•«æŠ˜ç·šèˆ‡é™°å½±é¢ç©
            if (points.length > 1) {
                const pathD = points.map((p, i) => (i === 0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`)).join(" ");
                const areaD = `${pathD} L ${points[points.length-1].x} ${height} L ${points[0].x} ${height} Z`;
                
                svgHTML += `<path d="${areaD}" fill="url(#chartGradient)" />`;
                svgHTML += `<path d="${pathD}" fill="none" stroke="#8bc34a" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />`;
            }

            // ç•«åœ“é»èˆ‡æ•¸å€¼ (å³ä½¿åªæœ‰ 1 ç­†ä¹ŸæœƒåŸ·è¡Œ)
            points.forEach(p => {
                svgHTML += `
                    <circle cx="${p.x}" cy="${p.y}" r="4" fill="white" stroke="#8bc34a" stroke-width="2" />
                    <text x="${p.x}" y="${p.y - 12}" text-anchor="middle" font-size="12" fill="#555" font-weight="bold">${p.val}</text>
                    <text x="${p.x}" y="${height - 2}" text-anchor="middle" font-size="10" fill="#aaa">${p.date}</text>
                `;
            });

            container.innerHTML = svgHTML;
        },
        // --- è«‹æ–°å¢æ­¤å‡½å¼åˆ° app ç‰©ä»¶ä¸­ ---

        openReport: () => {
            const plan = app.state.plan;
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            
            // 1. æ•¸æ“šè¨ˆç®—
            let totalCal = 0, totalP = 0, totalC = 0, totalF = 0;
            let dayCounts = 0;
            let dailyCals = [];

            days.forEach(d => {
                const rid = plan[d];
                const r = recipes.find(x => x.id === rid);
                if(r) {
                    totalCal += r.cal;
                    totalP += r.p;
                    totalC += r.c;
                    totalF += r.f;
                    dailyCals.push({ day: d, val: r.cal });
                    dayCounts++;
                } else {
                    dailyCals.push({ day: d, val: 0 });
                }
            });

            if(dayCounts === 0) return app.showToast('æœ¬é€±å°šæœªå®‰æ’èœå–®ï¼Œç„¡æ³•åˆ†æ');

            const avgCal = Math.round(totalCal / dayCounts);
            const avgP = Math.round(totalP / dayCounts);
            const avgC = Math.round(totalC / dayCounts);
            const avgF = Math.round(totalF / dayCounts);

            // ç†±é‡ä½”æ¯”ä¼°ç®— (P:4, C:4, F:9)
            const calP = avgP * 4;
            const calC = avgC * 4;
            const calF = avgF * 9;
            const calTotal = calP + calC + calF; // é‡æ–°è¨ˆç®—åˆ†æ¯ä»¥æ±‚ç²¾ç¢ºæ¯”ä¾‹
            
            const pctP = Math.round((calP / calTotal) * 100) || 0;
            const pctC = Math.round((calC / calTotal) * 100) || 0;
            const pctF = Math.round((calF / calTotal) * 100) || 0;

            // 2. æ¸²æŸ“æ–‡å­—æ•¸æ“š
            document.getElementById('report-total-cal').innerText = avgCal;
            document.getElementById('val-p').innerText = `${pctP}%`;
            document.getElementById('val-c').innerText = `${pctC}%`;
            document.getElementById('val-f').innerText = `${pctF}%`;

            // 3. ç¹ªè£½åœ“é¤…åœ– (SVG Stroke Dasharray)
            // åœ“å‘¨é•· = 2 * PI * R (R=32 -> C=200 æ–¹ä¾¿è¨ˆç®—)
            const R = 15.9155; // è®“å‘¨é•·ç´„ç­‰æ–¼ 100
            const pieSvg = document.getElementById('chart-macro-pie');
            
            // ç´¯ç©é€²åº¦ (å› ç‚º stroke æ˜¯å¾ 0 é–‹å§‹ç–ŠåŠ )
            // é †åº: è›‹ç™½è³ª(è—) -> ç¢³æ°´(é»ƒ) -> è„‚è‚ª(ç´…)
            // æ³¨æ„: stroke-dasharray="æ•¸å€¼ 100"
            
            pieSvg.innerHTML = `
                <circle cx="50" cy="50" r="${R}" fill="transparent" stroke="#f3f4f6" stroke-width="32"></circle>
                <circle cx="50" cy="50" r="${R}" fill="transparent" stroke="#f87171" stroke-width="32" 
                    stroke-dasharray="${pctP+pctC+pctF} 100" stroke-dashoffset="0"></circle>
                <circle cx="50" cy="50" r="${R}" fill="transparent" stroke="#facc15" stroke-width="32" 
                    stroke-dasharray="${pctP+pctC} 100" stroke-dashoffset="0"></circle>
                <circle cx="50" cy="50" r="${R}" fill="transparent" stroke="#60a5fa" stroke-width="32" 
                    stroke-dasharray="${pctP} 100" stroke-dashoffset="0"></circle>
            `;

            // 4. ç¹ªè£½é•·æ¢åœ– (SVG)
            const barSvg = document.getElementById('chart-cal-bar');
            const bW = 300, bH = 100, bPad = 10;
            const maxBarCal = Math.max(800, ...dailyCals.map(d=>d.val)); // Yè»¸æœ€å¤§å€¼
            
            const barsHtml = dailyCals.map((d, i) => {
                const barH = (d.val / maxBarCal) * (bH - 20);
                const x = bPad + i * ((bW - bPad*2) / 5);
                const barW = ((bW - bPad*2) / 5) - 10;
                const color = d.val > 0 ? '#8bc34a' : '#e5e7eb';
                return `
                    <rect x="${x}" y="${bH - barH - 15}" width="${barW}" height="${barH}" rx="4" fill="${color}" />
                    <text x="${x + barW/2}" y="${bH}" text-anchor="middle" font-size="10" fill="#9ca3af">${d.day}</text>
                    <text x="${x + barW/2}" y="${bH - barH - 18}" text-anchor="middle" font-size="10" fill="#6b7280" font-weight="bold">${d.val || '-'}</text>
                `;
            }).join('');

            // åŠ å…¥ä¸€æ¢ç›®æ¨™ç·š
            const targetY = bH - 15 - (app.state.user.tdee * 0.35 / maxBarCal) * (bH - 20);
            const lineHtml = `
                <line x1="0" y1="${targetY}" x2="300" y2="${targetY}" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4"/>
                <text x="5" y="${targetY - 5}" font-size="9" fill="#9ca3af">Target</text>
            `;

            barSvg.innerHTML = lineHtml + barsHtml;

            // 5. ç”ŸæˆçŸ­è©•
            let comment = "";
            if (pctP > 30) comment += "ğŸ’ª è›‹ç™½è³ªæ”å–å……è¶³ï¼Œæœ‰åŠ©æ–¼è‚Œè‚‰ä¿®å¾©èˆ‡ç”Ÿé•·ã€‚";
            else if (pctP < 15) comment += "ğŸ¥© è›‹ç™½è³ªæ¯”ä¾‹ç¨ä½ï¼Œå»ºè­°å¤šåŠ ä¸€é¡†è›‹æˆ–è±†æ¼¿ã€‚";
            
            if (pctF > 40) comment += " âš ï¸ è„‚è‚ªæ¯”ä¾‹åé«˜ï¼Œæ³¨æ„çƒ¹èª¿æ–¹å¼èˆ‡å …æœæ”å–é‡ã€‚";
            else if (pctC > 60) comment += " ğŸš ç¢³æ°´æ¯”ä¾‹è¼ƒé«˜ï¼Œè‹¥æ˜¯é‹å‹•æ—¥å‰‡éå¸¸åˆé©ã€‚";
            else comment += " ğŸ¥— ä¸‰å¤§ç‡Ÿé¤Šç´ åˆ†ä½ˆå‡è¡¡ï¼Œè«‹ç¹¼çºŒä¿æŒï¼";

            document.getElementById('report-comment').innerText = comment;
            document.getElementById('modal-report').classList.remove('hidden');
        },

        // --- 1. ä¿®æ”¹ generateAIPlan (åªè² è²¬é–‹è¦–çª—) ---
        generateAIPlan: () => {
            const user = app.state.user;
            if (!user || !user.apiKey) {
                app.showToast('è«‹å…ˆå¡«å¯« API Key');
                setTimeout(() => app.navigateTo('profile'), 1500);
                return;
            }
            
            // é å¡«å€‹äººè¨­å®šä¸­çš„æ’é™¤é£Ÿæ
            document.getElementById('ai-opt-exclude').value = user.exclude || '';
            document.getElementById('ai-opt-fridge').value = ''; // æ¸…ç©ºæ¸…å†°ç®±
            
            // æ‰“é–‹è¦–çª—
            document.getElementById('modal-ai-options').classList.remove('hidden');
        },

        // --- è«‹æ›¿æ› app.confirmAIPlan ---
        confirmAIPlan: async () => {
            app.closeModal('modal-ai-options');
            
            // æ­·å²ç´€éŒ„ä¿å­˜é‚è¼¯ (ç¶­æŒä¸è®Š)
            if (Object.values(app.state.plan).some(id => id)) {
                    if(await app.showModal("å³å°‡ç”Ÿæˆæ–°èœå–®ï¼Œæ˜¯å¦å°‡ç›®å‰çš„èœå–®å­˜å…¥æ­·å²ç´€éŒ„ï¼Ÿ", "ä¿å­˜ç¢ºèª")) {
                        if (!app.state.history) app.state.history = [];
                        app.state.history.unshift({
                            id: Date.now(),
                            date: new Date().toLocaleDateString('zh-TW'),
                            recipes: JSON.parse(JSON.stringify(recipes)),
                            plan: {...app.state.plan}
                        });
                        localStorage.setItem('bento_history', JSON.stringify(app.state.history));
                        app.showToast('âœ… å·²ä¿å­˜è‡³æ­·å²ç´€éŒ„');
                    }
                }

            // 1. ç²å–æ–°åƒæ•¸
            const fridgeItems = document.getElementById('ai-opt-fridge').value.trim();
            const tempExclude = document.getElementById('ai-opt-exclude').value.trim();
            
            // ç²å–é¸ä¸­çš„é¢¨å‘³
            const cuisineEl = document.querySelector('input[name="ai-cuisine"]:checked');
            const cuisine = cuisineEl ? cuisineEl.value : "å‡è¡¡å¥åº·";
            
            // ç²å–æ‡¶äººæ¨¡å¼
            const isBatch = document.getElementById('ai-opt-batch').checked;

            // 2. çµ„åˆ Prompt
            const fridgeNote = fridgeItems ? `â˜… å„ªå…ˆä½¿ç”¨å†°ç®±é£Ÿæï¼š${fridgeItems}` : "";
            const excludeNote = tempExclude ? `â˜… çµ•å°é¿é–‹é£Ÿæï¼š${tempExclude}` : "";
            
            // æ‡¶äººæ¨¡å¼æŒ‡ä»¤
            const batchNote = isBatch 
                ? "â˜… ä½¿ç”¨è€…é¸æ“‡ã€Œæ‡¶äººå‚™é¤æ¨¡å¼ã€ï¼šè«‹ç¢ºä¿é€™ 10 é“èœçš„é£Ÿæé‡è¤‡æ€§é«˜ã€æ˜“æ–¼æ‰¹é‡æ¡è²·èˆ‡å‚™æ–™ï¼ˆä¾‹å¦‚å¤šé“èœå…±ç”¨é›èƒ¸è‚‰æˆ–èŠ±æ¤°èœï¼‰ã€‚" 
                : "è«‹è¨­è¨ˆ 10 é“ã€Œå£å‘³å®Œå…¨ä¸åŒã€çš„èœè‰²ï¼Œå¢åŠ è±å¯Œåº¦ã€‚";

            // UI Loading
            const btn = document.querySelector('button[onclick="app.generateAIPlan()"]');
            const loading = document.getElementById('ai-loading');
            const list = document.getElementById('planner-list');
            
            if(btn) btn.classList.add('hidden');
            if(list) list.classList.add('hidden');
            if(loading) loading.classList.remove('hidden');

            try {
                const user = app.state.user;
                const targetCal = Math.round(user.tdee * 0.35);
                
                // èº«é«”æ•¸æ“šåˆ¤è®€é‚è¼¯ (è®“æ•¸æ“šèªªè©±)
                let bodyNote = "";
                if (user.bodyComp) {
                    const { bf, muscle } = user.bodyComp;
                    
                    // é«”è„‚ç‡åˆ¤æ–· (ç°¡å–®æ¨™æº–ï¼šç”·>25/å¥³>32 ç‚ºé«˜ï¼Œç”·<15/å¥³<22 ç‚ºä½)
                    // é€™è£¡ç”¨ä¸€å€‹é€šç”¨çš„ 25% ä½œç‚ºåˆ†ç•Œï¼Œæˆ–æ˜¯æ‚¨å¯ä»¥æ ¹æ“šæ€§åˆ¥å¯«æ›´ç´°
                    if (bf) {
                        if (bf > 28) {
                            bodyNote += "â˜… ä½¿ç”¨è€…é«”è„‚ç‡åé«˜ï¼Œè«‹åš´æ ¼æ§åˆ¶ã€Œç²¾ç·»æ¾±ç²‰ã€æ”å–ï¼Œå„ªå…ˆæ¨è–¦ä½GIé£Ÿæï¼ˆå¦‚ç³™ç±³ã€åœ°ç“œã€å—ç“œï¼‰ï¼Œä¸¦å¢åŠ è†³é£Ÿçº–ç¶­ã€‚";
                        } else if (bf < 18) {
                            bodyNote += "â˜… ä½¿ç”¨è€…é«”è„‚ç‡è¼ƒä½ï¼Œä»£è¬å¯èƒ½è¼ƒå¿«ï¼Œå¯é©åº¦å¢åŠ å„ªè³ªæ¾±ç²‰èˆ‡å¥åº·è„‚è‚ªï¼ˆå¦‚é…ªæ¢¨ã€å …æœï¼‰ä»¥ç¶­æŒèƒ½é‡ã€‚";
                        }
                    }
                    
                    // è‚Œè‚‰é‡/ç›®æ¨™åˆ¤æ–·
                    if (user.goal.includes('å¢è‚Œ') || (muscle && muscle > 30)) {
                        bodyNote += "â˜… ä½¿ç”¨è€…ç›®æ¨™ç‚ºå¢è‚Œæˆ–è‚Œè‚‰é‡è¼ƒé«˜ï¼Œè«‹ç¢ºä¿è›‹ç™½è³ªä¾†æºå¤šæ¨£åŒ–ä¸”å®¹æ˜“å¸æ”¶ï¼Œä¸¦é©ç•¶æ­é…ç¢³æ°´å¹«åŠ©åˆæˆã€‚";
                    }
                }

                // ğŸ”´ çµ±ä¸€çš„é«˜å“è³ª Prompt (é€±è¨ˆç•«)
                const aiPrompt = `
                    ä½ æ˜¯ä¸€ä½äº”æ˜Ÿç´šå¥åº·é¤ç›’è¨­è¨ˆå¸«ã€‚è«‹ç‚º TDEE ${user.tdee} (åˆé¤ç›®æ¨™ ${targetCal} kcal) çš„ä½¿ç”¨è€…ï¼Œè¨­è¨ˆ 5 å¤©åˆé¤ä¾¿ç•¶ã€‚
                    ç›®æ¨™ï¼š${user.goal}ã€‚
                    æ–™ç†é¢¨æ ¼ï¼š${cuisine}ã€‚
                    ä½¿ç”¨è€…èº«é«”ç‹€æ³ç‰¹åˆ¥æŒ‡ç¤ºã€‘
                    ${bodyNote || "ç„¡ç‰¹æ®Šèº«é«”ç‹€æ³ï¼Œè«‹ä¾å‡è¡¡é£²é£Ÿè¨­è¨ˆã€‚"}
                    ${batchNote}
                    ${fridgeNote}
                    ${excludeNote}
                    
                    ã€åš´æ ¼ JSON æ ¼å¼è¦æ±‚ã€‘
                    è«‹å›å‚³ä¸€å€‹ JSON Arrayï¼ŒåŒ…å« 10 å€‹ç‰©ä»¶ (è«‹ç¢ºä¿æ¯é“èœåéƒ½ä¸ä¸€æ¨£ï¼Œä¾›ä½¿ç”¨è€…æ›¿æ›é¸æ“‡)ã€‚**ä¸è¦åŒ…å«ä»»ä½• Markdown æ¨™è¨˜ (å¦‚ \`\`\`json) æˆ–é–‹é ­çµå°¾çš„è§£é‡‹æ–‡å­—**ã€‚
                    âš ï¸ é‡è¦ï¼šç„¡è«–æ˜¯å¦ç‚ºæ‡¶äººæ¨¡å¼ï¼Œéƒ½å¿…é ˆçµ¦è¶³ 10 å€‹ä¸åŒçš„ç‰©ä»¶ï¼Œä¸è¦å·æ‡¶åªçµ¦ 2 å€‹ã€‚
                    æ¯å€‹ç‰©ä»¶å¿…é ˆåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼ˆKey åç¨±å¿…é ˆå®Œå…¨ä¸€è‡´ï¼‰ï¼š
                    - "name": (å­—ä¸²) èœè‰²åç¨± (ä¾‹å¦‚ "é¦™ç…è¿·è¿­é¦™é›è…¿æ’ä½æ™‚è”¬")
                    - "main_tag": (å­—ä¸²) å››é¸ä¸€: "é›è‚‰", "ç‰›è‚‰", "æµ·é®®", "ç´ é£Ÿ"
                    - "cal": (æ•¸å­—) ç†±é‡
                    - "p": (æ•¸å­—) è›‹ç™½è³ª
                    - "c": (æ•¸å­—) ç¢³æ°´
                    - "f": (æ•¸å­—) è„‚è‚ª
                    - "ingredients": (ç‰©ä»¶é™£åˆ—) é£Ÿææ¸…å–®ï¼Œæ ¼å¼ç‚º [{"name":"é£Ÿæå", "qty":"æ•¸é‡(å¦‚ 100g)", "type":"ç”Ÿé®®/è”¬æœ/æ¾±ç²‰/é›œè²¨"}]ã€‚è«‹åˆ—å‡ºæ‰€æœ‰èª¿å‘³èˆ‡é…èœã€‚
                    - "instructions": (å­—ä¸²) çƒ¹é£ªæ­¥é©Ÿã€‚**é‡è¦ï¼šæ­¥é©Ÿä¹‹é–“è«‹å‹™å¿…ä½¿ç”¨ \\n æ›è¡Œ**ï¼Œä¸¦æ¨™ç¤º 1. 2. 3.ï¼Œæè¿°éœ€è©³ç´°ï¼ˆåŒ…å«ç«å€™ã€æ™‚é–“ï¼‰ã€‚

                    ç¯„ä¾‹ï¼š
                    [
                    {
                        "name": "ç¤ºç¯„èœè‰²",
                        "main_tag": "é›è‚‰",
                        "cal": 500, "p": 30, "c": 50, "f": 15,
                        "ingredients": [{"name":"é›èƒ¸è‚‰","qty":"150g","type":"ç”Ÿé®®"}, {"name":"èŠ±æ¤°èœ","qty":"100g","type":"è”¬æœ"}],
                        "instructions": "1. å‚™æ–™ï¼šé›è‚‰åˆ‡å¡Š...\\n2. çƒ¹èª¿ï¼šç†±é‹å¾Œæ”¾å…¥..."
                    }
                    ]
                `;

                const data = await app.callGeminiAPI(aiPrompt);
                
                // è³‡æ–™è™•ç† (é˜²å‘†ï¼šç¢ºä¿æ¬„ä½å­˜åœ¨)
                recipes = data.map((r, i) => ({
                    ...r, 
                    id: Date.now() + i, 
                    tags: [r.main_tag || 'ä¸€èˆ¬'], 
                    favorite: false,
                    
                    // âœ… åŠ å¼·é˜²å‘†ï¼šç¢ºä¿ ingredients æ˜¯é™£åˆ—ï¼Œå¦å‰‡çµ¦ç©ºé™£åˆ—ï¼Œé¿å… map å ±éŒ¯
                    ingredients: Array.isArray(r.ingredients) 
                        ? r.ingredients.map(ing => `${ing.name} ${ing.qty}`) 
                        : [],
                        
                    structured_ingredients: Array.isArray(r.ingredients) ? r.ingredients : []
                }));
                
                localStorage.setItem('bento_recipes', JSON.stringify(recipes));
                // ç”±ç¨‹å¼é‚è¼¯ä¾†åˆ†é…ã€Œæ‡¶äººã€æˆ–ã€Œè±å¯Œã€
                // AI è² è²¬çµ¦ 10 å€‹é¸æ“‡ï¼Œæˆ‘å€‘è² è²¬æ±ºå®šæ€éº¼åƒ  
                if (isBatch) {
                    // æ‡¶äººæ¨¡å¼ï¼šåªç”¨å‰ 3 é“èœå¡«æ»¿ 5 å¤© (A, A, B, B, C)
                    // recipes[3] ~ recipes[9] æœƒè‡ªå‹•è®Šæˆæ›¿æ›é¸é …
                    app.state.plan = { 
                        Mon: recipes[0].id, 
                        Tue: recipes[0].id, 
                        Wed: recipes[1].id, 
                        Thu: recipes[1].id, 
                        Fri: recipes[2].id 
                    };
                } else {
                    // ä¸€èˆ¬æ¨¡å¼ï¼šå‰ 5 é“èœå¡«æ»¿ 5 å¤© (A, B, C, D, E)
                    app.state.plan = { 
                        Mon: recipes[0].id, 
                        Tue: recipes[1].id, 
                        Wed: recipes[2].id, 
                        Thu: recipes[3].id, 
                        Fri: recipes[4].id 
                    };
                }
                    app.state.shopping = {};
                    localStorage.setItem('bento_shopping', JSON.stringify(app.state.shopping));

                    const msgType = isBatch ? "æ‡¶äºº (å·²é ç•™7é“æ›¿æ›èœ)" : "è±å¯Œ (å·²é ç•™5é“æ›¿æ›èœ)";
                    app.showToast(`ğŸ‰ å·²æ ¹æ“šæ‚¨çš„èº«é«”æ•¸æ“šç”Ÿæˆã€Œ${cuisine}ã€${msgType}æ¸…å–®ï¼`);
                    app.renderPlanner();

                } catch (e) {
                   await app.showModal(`ç”Ÿæˆå¤±æ•—: ${e.message}`, "ç³»çµ±éŒ¯èª¤", "error");
                } finally {
                    if(loading) loading.classList.add('hidden');
                    if(btn) btn.classList.remove('hidden');
                    if(list) list.classList.remove('hidden');
                }
            },
        // --- 3. æ–°å¢ rerollDay (å–®æ—¥é‡éª°) ---
        rerollDay: async (dayKey) => {
            if(!(await app.showModal(`ç¢ºå®šè¦é‡æ–°ç”Ÿæˆã€Œ${dayLabels[dayKey]}ã€çš„ä¾¿ç•¶å—ï¼Ÿ`, "é‡éª°ç¢ºèª"))) return;

            const user = app.state.user;
            const targetCal = Math.round(user.tdee * 0.35);
            // ğŸ”´ ä¿®æ­£é‡é»ï¼šæ”¶é›†ç›®å‰æ‰€æœ‰å·²å­˜åœ¨çš„èœåï¼Œé˜²æ­¢ AI ç”Ÿæˆé‡è¤‡çš„
            const currentRecipeNames = recipes.filter(r => r.name).map(r => r.name).join('ã€');
            const avoidNote = currentRecipeNames 
                    ? `âš ï¸ çµ•å°é¿é–‹ä»¥ä¸‹èœè‰²ï¼ˆè«‹å‹¿ç”Ÿæˆé‡è¤‡æˆ–æ¥µåº¦ç›¸ä¼¼çš„ï¼‰ï¼š${currentRecipeNames}` 
                    : "";
            const excludeNote = user.exclude ? `â˜… ä½¿ç”¨è€…å¿Œå£ï¼š${user.exclude}` : "";

            const card = document.getElementById(`plan-card-${dayKey}`);
            const originalContent = card.innerHTML;
            card.innerHTML = `<div class="flex justify-center items-center h-20 text-brand-500"><i class="fa-solid fa-circle-notch fa-spin text-xl"></i></div>`;

            try {
                // ğŸ”´ çµ±ä¸€çš„é«˜å“è³ª Prompt (å–®æ—¥ç‰ˆ)
                const aiPrompt = `
                    ä½ æ˜¯ä¸€ä½äº”æ˜Ÿç´šå¥åº·é¤ç›’è¨­è¨ˆå¸«ã€‚è«‹è¨­è¨ˆ 1 é“ã€Œè©³ç´°ä¸”ç¾å‘³ã€çš„åˆé¤ä¾¿ç•¶ï¼Œå–ä»£åŸæœ¬çš„èœè‰²ã€‚
                    ç†±é‡ç´„ ${targetCal} kcalï¼Œç›®æ¨™ï¼š${user.goal}ã€‚
                    ${excludeNote}
                    ã€é˜²é‡è¤‡æ©Ÿåˆ¶ã€‘ ç›®å‰å·²æœ‰çš„èœè‰²åŒ…æ‹¬ï¼š${currentRecipeNames}ã€‚è«‹è¨­è¨ˆä¸€å€‹ã€Œå…¨æ–°ä¸”ä¸åŒã€çš„èœè‰²ï¼Œçµ•å°ä¸å¯é‡è¤‡æˆ–æ¥µåº¦ç›¸ä¼¼ã€‚
                    ${avoidNote}

                    ã€åš´æ ¼ JSON æ ¼å¼è¦æ±‚ã€‘
                    è«‹å›å‚³åŒ…å« 1 å€‹ç‰©ä»¶çš„ JSON Arrayã€‚**ä¸è¦åŒ…å«ä»»ä½• Markdown æ¨™è¨˜ (å¦‚ \`\`\`json) æˆ–é–‹é ­çµå°¾çš„è§£é‡‹æ–‡å­—**ã€‚æ¬„ä½å¿…é ˆå®Œå…¨ä¸€è‡´ï¼š
                    - "name": (å­—ä¸²) èœè‰²åç¨±
                    - "main_tag": (å­—ä¸²) "é›è‚‰", "ç‰›è‚‰", "æµ·é®®", "ç´ é£Ÿ"
                    - "cal": (æ•¸å­—)
                    - "p": (æ•¸å­—)
                    - "c": (æ•¸å­—)
                    - "f": (æ•¸å­—)
                    - "ingredients": [{"name":"é£Ÿæå", "qty":"æ•¸é‡", "type":"ç”Ÿé®®/è”¬æœ/æ¾±ç²‰/é›œè²¨"}]
                    - "instructions": (å­—ä¸²) æ­¥é©Ÿè«‹ç”¨ \\n åˆ†éš”ï¼Œæè¿°éœ€è©³ç´°ã€‚
                `;

                const data = await app.callGeminiAPI(aiPrompt);
                
                // æª¢æŸ¥æ•¸æ“šæ˜¯å¦å®Œæ•´ (è§£æ±º undefined å•é¡Œ)
                const item = data[0];
                if (!item.name || !item.ingredients) throw new Error("AI å›å‚³æ ¼å¼ä¸å®Œæ•´ï¼Œè«‹é‡è©¦");
                // äºŒæ¬¡æª¢æŸ¥ï¼šå¦‚æœ AI é‚„æ˜¯çµ¦äº†é‡è¤‡çš„åå­— (æ©Ÿç‡å¾ˆä½)ï¼Œè‡ªå‹•åŠ å€‹ (æ–°)
                let finalName = item.name;
                if (recipes.some(r => r.name === finalName)) {
                    finalName += " (ç‰¹è£½)";
                }
                const newRecipe = {
                    ...item, 
                    id: Date.now(), 
                    tags: [item.main_tag || 'ä¸€èˆ¬'], 
                    favorite: false,
                    ingredients: item.ingredients.map(ing => `${ing.name} ${ing.qty}`),
                    structured_ingredients: item.ingredients
                };

                recipes.push(newRecipe);
                localStorage.setItem('bento_recipes', JSON.stringify(recipes));
                
                app.state.plan[dayKey] = newRecipe.id;
                localStorage.setItem('bento_plan', JSON.stringify(app.state.plan));

                app.showToast('âœ¨ æ–°èœè‰²å·²ä¸Šæ¡Œï¼');
                app.renderPlanner();

            } catch (e) {
                console.error(e);
               await app.showModal('é‡éª°å¤±æ•—: ' + e.message, "ç³»çµ±éŒ¯èª¤", "error");
                card.innerHTML = originalContent;
            }
        },
// --- [ä¿®å¾©ç‰ˆ] 2. å…±ç”¨ API å‘¼å«é‚è¼¯ (ç§»é™¤ç„¡æ•ˆæ¨¡å‹) ---
        callGeminiAPI: async (promptText) => {
            const key = app.state.user.apiKey;
            
            if (!key) {
                alert("éŒ¯èª¤ï¼šæœªå¡«å¯« API Key");
                throw new Error("No API Key");
            }

            // âœ… ä¿®æ­£ï¼šåªä½¿ç”¨æ‚¨å¸³è™Ÿæ”¯æ´çš„æ¨¡å‹ (ç§»é™¤ gemini-pro é¿å… 404 éŒ¯èª¤)
            // é †åºï¼šå„ªå…ˆå˜—è©¦ 2.0 Flashï¼Œå¤±æ•—æ™‚å‚™æ´ 1.5 Flash
            const models = ['gemini-flash-latest', 'gemini-2.0-flash' ];
            
            let lastErrorMsg = "";

            for (const model of models) {
                try {
                    console.log(`ğŸš€ æ­£åœ¨å˜—è©¦æ¨¡å‹: ${model}...`);
                    
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
                    
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: promptText }] }],
                            generationConfig: { 
                                response_mime_type: "application/json" 
                            },
                            // å®‰å…¨è¨­å®šï¼šé˜²æ­¢é£Ÿè­œè¢«èª¤åˆ¤ç‚ºæš´åŠ›
                            safetySettings: [
                                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                            ]
                        })
                    });

                    if(!res.ok) {
                        const errData = await res.json().catch(() => ({}));
                        const errMsg = errData.error?.message || `Status ${res.status}`;
                        console.warn(`âŒ æ¨¡å‹ ${model} å¤±æ•—: ${errMsg}`);
                        lastErrorMsg = `(${model}) ${errMsg}`;
                        
                        // 400 (Key éŒ¯èª¤) æˆ– 404 (æ¨¡å‹æ‰¾ä¸åˆ°) ç›´æ¥è·³éæˆ–å ±éŒ¯
                        if (res.status === 400) throw new Error("API Key ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢ºã€‚");
                        
                        continue; 
                    }

                    const data = await res.json();
                    
                    if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                        lastErrorMsg = "API å›å‚³å…§å®¹ç‚ºç©º (å¯èƒ½è¢«é˜»æ“‹)";
                        continue;
                    }

                    const rawText = data.candidates[0].content.parts[0].text;
                    
                    // JSON æ¸…æ´—
                    let jsonString = rawText.trim();
                    jsonString = jsonString.replace(/^```json/i, '').replace(/^```/, '').replace(/```$/, '');
                    
                    const firstBracket = jsonString.indexOf('[');
                    const lastBracket = jsonString.lastIndexOf(']');
                    
                    if (firstBracket !== -1 && lastBracket !== -1) {
                        jsonString = jsonString.substring(firstBracket, lastBracket + 1);
                    } else {
                         // å®¹éŒ¯ï¼šå¦‚æœæ˜¯å–®ä¸€ç‰©ä»¶ { ... } å‰‡åŒ…æˆé™£åˆ—
                        const firstBrace = jsonString.indexOf('{');
                        const lastBrace = jsonString.lastIndexOf('}');
                        if (firstBrace !== -1 && lastBrace !== -1) {
                            jsonString = `[${jsonString.substring(firstBrace, lastBrace + 1)}]`;
                        }
                    }

                    try {
                        const parsed = JSON.parse(jsonString);
                        console.log(`âœ… ${model} ç”ŸæˆæˆåŠŸï¼`);
                        return Array.isArray(parsed) ? parsed : [parsed];
                    } catch (e) {
                        console.error("è§£æå¤±æ•—:", rawText);
                        lastErrorMsg = "JSON è§£æå¤±æ•—";
                        continue;
                    }

                } catch(e) {
                    console.error(e);
                    lastErrorMsg = e.message;
                    if (e.message.includes("API Key")) break;
                }
            }

            alert(`ç”Ÿæˆå¤±æ•—ï¼\n\nåŸå› ï¼š${lastErrorMsg}\n\nè«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ– API Keyã€‚`);
            throw new Error(lastErrorMsg);
        },
        // --- è«‹æ›¿æ› app ç‰©ä»¶ä¸­çš„ renderPlanner ---
        renderPlanner: () => {
            const list = document.getElementById('planner-list');
            list.innerHTML = '';
            const dayLabels = { 'Mon': 'é€±ä¸€', 'Tue': 'é€±äºŒ', 'Wed': 'é€±ä¸‰', 'Thu': 'é€±å››', 'Fri': 'é€±äº”' };

            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].forEach(d => {
                const rid = app.state.plan[d];
                const r = recipes.find(x => x.id === rid);
                const el = document.createElement('div');
                // åŠ å…¥ ID æ–¹ä¾¿é‡éª°æ™‚å®šä½
                el.id = `plan-card-${d}`; 
                el.className = "bg-white p-3 rounded-2xl border border-gray-100 flex items-center gap-3 transition active:scale-[0.98] group";
                
                const dayText = dayLabels[d]; 

                if(r) {
                    el.innerHTML = `
                        <div class="w-10 font-bold text-gray-400 text-sm text-center tracking-widest shrink-0">${dayText}</div>
                        <div class="w-14 h-14 rounded-xl bg-brand-50 flex items-center justify-center text-brand-500 text-2xl shrink-0">
                            <i class="fa-solid fa-bowl-rice"></i>
                        </div>
                        
                        <div class="flex-1 min-w-0 cursor-pointer" onclick="app.openDetailById(${r.id})">
                            <h4 class="font-bold text-gray-700 text-sm truncate">${r.name}</h4>
                            <div class="text-[10px] text-gray-400 mt-0.5">${r.cal} Kcal Â· ${r.tags[0]}</div>
                        </div>

                        <div class="flex gap-1">
                            <button onclick="app.rerollDay('${d}')" class="w-8 h-8 rounded-full bg-purple-50 text-purple-400 flex items-center justify-center hover:bg-purple-500 hover:text-white transition shadow-sm" title="AI é‡éª°é€™é¤">
                                <i class="fa-solid fa-wand-magic-sparkles text-xs"></i>
                            </button>
                            <button onclick="app.openSelector('${d}')" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center hover:bg-brand-500 hover:text-white transition shadow-sm" title="æ‰‹å‹•é¸æ“‡">
                                <i class="fa-solid fa-rotate text-xs"></i>
                            </button>
                        </div>
                    `;
                } else {
                    // ç©ºç‹€æ…‹ä¿æŒä¸è®Š...
                    el.innerHTML = `
                        <div class="w-10 font-bold text-gray-400 text-sm text-center tracking-widest">${dayText}</div>
                        <div class="w-14 h-14 rounded-xl bg-gray-50 flex items-center justify-center text-gray-200"><i class="fa-solid fa-plus"></i></div>
                        <div class="flex-1 text-sm text-gray-400">å°šæœªå®‰æ’</div>
                        <button onclick="app.openSelector('${d}')" class="bg-brand-500 text-white text-xs px-3 py-1.5 rounded-full font-bold shadow-sm">é¸æ“‡</button>
                    `;
                }
                list.appendChild(el);
            });
        },
            // --- INGREDIENT SPLITTER & AGGREGATOR (NEW) ---
            getAggregatedIngredients: () => {
                const needed = new Set();
                Object.values(app.state.plan).forEach(rid => {
                    const r = recipes.find(x => x.id === rid);
                    if (r && r.ingredients) {
                        r.ingredients.forEach(str => {
                            // Split by separators: ã€ , ï¼Œ / or space
                            const items = str.split(/[ã€,ï¼Œ\/ ]+/); 
                            items.forEach(item => {
                                const cleanItem = item.trim();
                                if(cleanItem && cleanItem.length > 0) needed.add(cleanItem);
                            });
                        });
                    }
                });
                return needed;
            },

            // --- CATEGORY LOGIC (ENHANCED) ---
            getCategory: (name) => {
                const n = name.toLowerCase();
                // 1. Meat/Fresh (Priority High: Tofu, Dairy, Meat)
                if (n.match(/é›|ç‰›|è±¬|é­š|è¦|è‚‰|æ’|ç¾Š|é´¨|éµ|æµ·é®®|è›‹|åŸ¹æ ¹|é¦™è…¸|é®­|é®ª|é¯–|é¯›|è›¤|èšµ|å·|æ¿è±†è…|å«©è±†è…|è±†å¹²|è±†è…|èµ·å¸|ä¹³é…ª|å¥¶|å„ªæ ¼|ç«è…¿|ä¸¸/)) return "ğŸ¥© ç”Ÿé®®å†·è—";
                
                // 2. Veg (Medium)
                if (n.match(/èœ|è‡|èŒ„|æ¤’|ç­|ç“œ|è‘‰|è±†|è˜¿è””|æ´‹è”¥|è”¥|è’œ|ç•ªèŒ„|èŠ±æ¤°|è–‘|æª¸æª¬|è–¯|èŠ‹|ç‰ç±³|ä¹å±¤å¡”|é¦™èœ|æ²™æ‹‰|æœ|è˜‹|è•‰|æ¢¨|æ¡ƒ|æ©™|æ©˜|ç™¾åˆ|å±±è—¥|ç§‹è‘µ|è“®è—•|è˜†ç­|ç¾…å‹’|è¿·è¿­é¦™|ç™¾é‡Œé¦™|é…ªæ¢¨/)) return "ğŸ¥¦ è”¬æœå€";
                
                // 3. Grains
                if (n.match(/ç±³|éºµ|é£¯|å†¬ç²‰|è—œéº¥|ç‡•éº¥|åå¸|éºµåŒ…|é¥…é ­|é¤ƒ|çš®|é¤…|ç²‰æ¢|æ„éºµ|çƒé¾|å¯¬ç²‰/)) return "ğŸš ç©€ç‰©æ¾±ç²‰";
                
                // 4. Seasoning & Others (Catch-all)
                if (n.match(/æ²¹|é†¬|é¹½|ç³–|é†‹|é…’|ç²‰|èƒ¡æ¤’|é¦™æ–™|å‘³æ·‹|å‘³å™Œ|é«˜æ¹¯|ç½é ­|å …æœ|èŠéº»|èœœ|èŒ¶|æ°´|ä¸ƒå‘³|è¾£æ¤’|å’–å“©|æ¹¯å¡Š|ç¾©å¤§åˆ©é¦™æ–™/)) return "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨";
                
                return "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨"; // Default
            },

            // --- è«‹æ›´æ–° renderShopping å‡½å¼ ---

            renderShopping: () => {
                const container = document.getElementById('shopping-list-container');
                
                // 1. æ”¶é›†æ‰€æœ‰é£Ÿæ (Aggregation)
                const aggMap = {};
                Object.values(app.state.plan).forEach(rid => {
                    const r = recipes.find(x => x.id === rid);
                    if (r) {
                        if (r.structured_ingredients) {
                            r.structured_ingredients.forEach(item => {
                                const name = item.name.trim();
                                if (!aggMap[name]) aggMap[name] = { type: item.type, qtys: [] };
                                aggMap[name].qtys.push(item.qty);
                            });
                        } else if (r.ingredients) {
                            r.ingredients.forEach(str => {
                                aggMap[str] = { type: "é›œè²¨", qtys: ["1ä»½"] }; 
                            });
                        }
                    }
                });

                if(Object.keys(aggMap).length === 0) {
                    // é€²åº¦æ¢æ­¸é›¶
                    document.getElementById('shop-progress-bar').style.width = '0%';
                    return container.innerHTML = `<div class="text-center text-gray-300 py-10 text-xs">æš«ç„¡æ¸…å–®</div>`;
                }
                
                // 2. å»ºç«‹åˆ†é¡å°æ‡‰
                const typeMapping = {
                    "ç”Ÿé®®": "ğŸ¥© ç”Ÿé®®å†·è—", "è‚‰é¡": "ğŸ¥© ç”Ÿé®®å†·è—", "æµ·é®®": "ğŸ¥© ç”Ÿé®®å†·è—",
                    "è”¬æœ": "ğŸ¥¦ è”¬æœå€", "è”¬èœ": "ğŸ¥¦ è”¬æœå€",
                    "æ¾±ç²‰": "ğŸš ç©€ç‰©æ¾±ç²‰",
                    "é›œè²¨": "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨", "ä¹¾æ–™": "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨"
                };

                const cats = { "ğŸ¥¦ è”¬æœå€": [], "ğŸ¥© ç”Ÿé®®å†·è—": [], "ğŸš ç©€ç‰©æ¾±ç²‰": [], "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨": [] };
                
                let totalItems = 0;
                let checkedItems = 0;

                // 3. åˆ†é…èˆ‡çµ±è¨ˆ
                Object.keys(aggMap).forEach(name => {
                    const itemData = aggMap[name];
                    let targetCat = typeMapping[itemData.type] || "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨";
                    
                    const qtyStr = itemData.qtys.join(' + ');
                    const displayName = `${name} <span class="text-xs text-brand-500 ml-1">(${qtyStr})</span>`;
                    const key = name;

                    cats[targetCat].push({ displayName, key });
                    
                    totalItems++;
                    if (app.state.shopping[key]) checkedItems++;
                });

                // 4. æ›´æ–°é€²åº¦æ¢ (ç§»é™¤æ–‡å­—æ›´æ–°é‚è¼¯)
                // document.getElementById('shop-progress-text').innerText = ... (é€™è¡Œå·²ç§»é™¤)
                const percent = totalItems > 0 ? (checkedItems/totalItems)*100 : 0;
                document.getElementById('shop-progress-bar').style.width = `${percent}%`;

                // 5. æ¸²æŸ“ç•«é¢ (èˆ‡ä¹‹å‰ç›¸åŒ)
                container.innerHTML = '';
                Object.keys(cats).forEach(catName => {
                    if(cats[catName].length > 0) {
                        const items = cats[catName];
                        // æ’åºï¼šæœªè²·çš„åœ¨å‰
                        items.sort((a,b) => {
                            const cA = app.state.shopping[a.key] ? 1 : 0;
                            const cB = app.state.shopping[b.key] ? 1 : 0;
                            return cA - cB || a.key.localeCompare(b.key, 'zh-Hant');
                        });

                        const grp = document.createElement('div');
                        grp.className = "mb-6";
                        grp.innerHTML = `<h3 class="text-xs font-bold text-gray-400 mb-3 px-1 tracking-wider border-b border-gray-100 pb-1">${catName}</h3>`;
                        
                        const listDiv = document.createElement('div');
                        listDiv.className = "flex flex-col gap-2"; 
                        
                        items.forEach(obj => {
                            const checked = app.state.shopping[obj.key];
                            const row = document.createElement('label');
                            row.className = `flex items-center gap-4 py-2 px-2 cursor-pointer group transition-all duration-300 ${checked ? 'opacity-30' : 'opacity-100'}`;
                            row.innerHTML = `
                                <input type="checkbox" class="hidden custom-checkbox" ${checked?'checked':''} onchange="app.toggleShop('${obj.key}')">
                                <div class="w-6 h-6 rounded border-2 border-gray-300 flex items-center justify-center transition-colors shrink-0 text-white text-xs">
                                    <i class="fa-solid fa-check ${checked?'':'hidden'}"></i>
                                </div>
                                <span class="text-base font-medium ${checked?'line-through':''} text-gray-700 flex-1">${obj.displayName}</span>
                            `;
                            listDiv.appendChild(row);
                        });
                        grp.appendChild(listDiv);
                        container.appendChild(grp);
                    }
                });
            },
            toggleShop: (item) => {
                app.state.shopping[item] = !app.state.shopping[item];
                localStorage.setItem('bento_shopping', JSON.stringify(app.state.shopping));
                app.renderShopping();
            },

            clearShoppingList: () => {
                for(let k in app.state.shopping) { if(app.state.shopping[k]) delete app.state.shopping[k]; }
                localStorage.setItem('bento_shopping', JSON.stringify(app.state.shopping));
                app.renderShopping();
            },

            // --- è«‹æ›¿æ› app.copyShoppingList ---
            copyShoppingList: async () => {
                // 1. å»ºç«‹åˆ†é¡å°æ‡‰è¡¨ (èˆ‡ renderShopping ä¿æŒä¸€è‡´)
                const typeMapping = {
                    "ç”Ÿé®®": "ğŸ¥© ç”Ÿé®®å†·è—", "è‚‰é¡": "ğŸ¥© ç”Ÿé®®å†·è—", "æµ·é®®": "ğŸ¥© ç”Ÿé®®å†·è—",
                    "è”¬æœ": "ğŸ¥¦ è”¬æœå€", "è”¬èœ": "ğŸ¥¦ è”¬æœå€",
                    "æ¾±ç²‰": "ğŸš ç©€ç‰©æ¾±ç²‰",
                    "é›œè²¨": "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨", "ä¹¾æ–™": "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨"
                };

                const cats = { 
                    "ğŸ¥© ç”Ÿé®®å†·è—": [], 
                    "ğŸ¥¦ è”¬æœå€": [], 
                    "ğŸš ç©€ç‰©æ¾±ç²‰": [], 
                    "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨": [] 
                };

                let hasItems = false;

                // 2. éæ­·æœ¬é€±è¨ˆç•«ï¼Œæ”¶é›†æœªè²·æ¸…å–®
                Object.values(app.state.plan).forEach(rid => {
                    const r = recipes.find(x => x.id === rid);
                    if (r) {
                        // å„ªå…ˆä½¿ç”¨çµæ§‹åŒ–è³‡æ–™ (AI ç”Ÿæˆçš„éƒ½æœ‰é€™å€‹)
                        const ingredients = r.structured_ingredients || 
                            (r.ingredients ? r.ingredients.map(s => ({name: s, qty: '', type: 'é›œè²¨'})) : []);

                        ingredients.forEach(item => {
                            const name = item.name.trim();
                            
                            // åªè™•ç†æœªæ‰“å‹¾(æœªè²·)çš„é …ç›®
                            // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ name ä½œç‚º keyï¼Œéœ€èˆ‡ toggleShop çš„ key é‚è¼¯ä¸€è‡´
                            if (!app.state.shopping[name]) {
                                // åˆ¤æ–·åˆ†é¡
                                let targetCat = typeMapping[item.type] || "ğŸ§‚ èª¿å‘³èˆ‡é›œè²¨";
                                
                                // ç‚ºäº†é¿å…é‡è¤‡åˆ—å‡º (ä¾‹å¦‚: é›èƒ¸è‚‰ 100g, é›èƒ¸è‚‰ 50g)ï¼Œæˆ‘å€‘å…ˆå­˜å­—ä¸²
                                // é€™è£¡åšå€‹ç°¡å–®è™•ç†ï¼šç›´æ¥åˆ—å‡º "å“å (æ•¸é‡)"
                                const displayStr = item.qty ? `${name} (${item.qty})` : name;
                                
                                cats[targetCat].push(displayStr);
                                hasItems = true;
                            }
                        });
                    }
                });

                if (!hasItems) return app.showToast('ğŸ‰ æ‰€æœ‰é£Ÿæéƒ½è²·é½Šå›‰ï¼');

                // 3. çµ„åˆæ–‡å­—
                let text = "ğŸ›’ Bento Fit æ¡è²·æ¸…å–®\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n";
                
                Object.keys(cats).forEach(catName => {
                    // å»é™¤é‡è¤‡ä¸¦æ’åº
                    const uniqueItems = [...new Set(cats[catName])].sort();
                    
                    if (uniqueItems.length > 0) {
                        text += `\n${catName}\n`;
                        uniqueItems.forEach(i => text += `â¬œ ${i}\n`);
                    }
                });
                
                text += `\nğŸ“… ${new Date().toLocaleDateString()} ç”Ÿæˆ`;

                // 4. åˆ†äº«æˆ–è¤‡è£½
                if (navigator.share) {
                    try {
                        await navigator.share({ title: 'Bento Fit æ¡è²·æ¸…å–®', text: text });
                    } catch (err) { console.log('å–æ¶ˆåˆ†äº«'); }
                } else {
                    navigator.clipboard.writeText(text);
                    app.showToast('âœ… å·²è¤‡è£½åˆ†å€æ¸…å–®');
                }
            },
            // --- History ---
            renderHistory: () => {
                const list = document.getElementById('history-list');
                const empty = document.getElementById('history-empty');
                list.innerHTML = '';
                
                if(app.state.history.length === 0) {
                    list.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                list.classList.remove('hidden');
                empty.classList.add('hidden');

                app.state.history.forEach((h, idx) => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-2xl border border-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-50";
                    div.onclick = () => app.openHistoryDetail(idx);
                    div.innerHTML = `
                        <div>
                            <div class="text-[10px] font-bold text-brand-500 uppercase mb-1">${h.date}</div>
                            <div class="text-sm font-bold text-gray-700">é€±èœå–®ç´€éŒ„ #${app.state.history.length - idx}</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                    `;
                    list.appendChild(div);
                });
            },

            openHistoryDetail: (idx) => {
                const h = app.state.history[idx];
                const head = document.getElementById('history-header');
                const body = document.getElementById('history-content');
                
                head.innerHTML = `
                    <h3 class="font-bold text-gray-800">ç´€éŒ„ ${h.date}</h3>
                    <div class="flex gap-2">
                        <button onclick="app.restoreHistory(${idx})" class="text-xs bg-brand-100 text-brand-600 px-3 py-1.5 rounded-full font-bold">å¥—ç”¨</button>
                        <button onclick="app.closeModal('modal-history')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center"><i class="fa-solid fa-times text-gray-400"></i></button>
                    </div>
                `;
                
                body.innerHTML = '';
                days.forEach(d => {
                    const rid = h.plan[d];
                    const r = h.recipes.find(x => x.id === rid);
                    const row = document.createElement('div');
                    row.className = "flex items-center gap-3 p-2 border-b border-gray-50 last:border-0";
                    if(r) {
                        row.innerHTML = `<span class="text-xs font-mono text-gray-400 w-6">${d}</span><span class="text-sm font-medium text-gray-700">${r.name}</span>`;
                    } else {
                        row.innerHTML = `<span class="text-xs font-mono text-gray-400 w-6">${d}</span><span class="text-sm text-gray-300">--</span>`;
                    }
                    body.appendChild(row);
                });
                
                document.getElementById('modal-history').classList.remove('hidden');
            },

            restoreHistory: async (idx) => { // âš ï¸ è¨˜å¾—åŠ  async
                // âœ… ä¿®æ”¹è™•
                if(!(await app.showModal('ç¢ºå®šè¦é‚„åŸæ­¤ç´€éŒ„å—ï¼Ÿç›®å‰çš„è¦åŠƒå°‡è¢«è¦†è“‹ã€‚', "é‚„åŸç¢ºèª"))) return;
                
                const h = app.state.history[idx];
                recipes = h.recipes;
                localStorage.setItem('bento_recipes', JSON.stringify(recipes));
                app.state.plan = h.plan;
                localStorage.setItem('bento_plan', JSON.stringify(app.state.plan));
                app.state.shopping = {};
                localStorage.setItem('bento_shopping', JSON.stringify({}));
                
                app.closeModal('modal-history');
                app.showToast('âœ… å·²é‚„åŸæ­·å²èœå–®');
                app.renderPlanner();
            },

            // --- Helpers ---
            // --- è«‹æ–°å¢/æ›¿æ› app ç‰©ä»¶ä¸­çš„ä»¥ä¸‹å‡½å¼ ---

            // 1. æ–°å¢ï¼šåˆ‡æ›æ”¶è—ç‹€æ…‹
            toggleFavorite: (id) => {
                const r = recipes.find(x => x.id === id);
                if(r) {
                    r.favorite = !r.favorite; // åˆ‡æ› boolean
                    localStorage.setItem('bento_recipes', JSON.stringify(recipes));
                    
                    // æ›´æ–° UI æŒ‰éˆ•ç‹€æ…‹
                    const btn = document.getElementById('btn-fav-toggle');
                    if(btn) {
                        btn.innerHTML = r.favorite ? '<i class="fa-solid fa-heart text-red-500 text-lg"></i>' : '<i class="fa-regular fa-heart"></i>';
                        btn.classList.toggle('bg-white', r.favorite); // é«˜äº®èƒŒæ™¯
                        btn.classList.toggle('bg-white/20', !r.favorite);
                    }
                    
                    app.showToast(r.favorite ? 'â¤ï¸ å·²åŠ å…¥æ”¶è—' : 'ğŸ’” å·²å–æ¶ˆæ”¶è—');
                }
            },

            // --- è«‹æ›¿æ› app.openDetail å‡½å¼ ---
            openDetail: (r) => {
                if(!r) return;
                document.getElementById('detail-title').innerText = r.name;
                document.getElementById('detail-cal').innerText = `${r.cal} Kcal`;
                document.getElementById('detail-p').innerText = r.p + 'g';
                document.getElementById('detail-c').innerText = r.c + 'g';
                document.getElementById('detail-f').innerText = r.f + 'g';
                
                const favBtn = document.getElementById('btn-fav-toggle');
                favBtn.onclick = () => app.toggleFavorite(r.id);
                
                if(r.favorite) {
                    favBtn.innerHTML = '<i class="fa-solid fa-heart text-red-500 text-lg"></i>';
                    favBtn.className = "absolute top-4 right-16 w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm transition active:scale-90";
                } else {
                    favBtn.innerHTML = '<i class="fa-regular fa-heart text-white"></i>';
                    favBtn.className = "absolute top-4 right-16 w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center hover:bg-white/30 transition active:scale-90";
                }

                const ingEl = document.getElementById('detail-ingredients');
                ingEl.innerHTML = '';
                // å®¹éŒ¯è™•ç†ï¼šå¦‚æœ ingredients ä¸æ˜¯é™£åˆ— (ä¾‹å¦‚ AI å›å‚³éŒ¯èª¤)ï¼Œå˜—è©¦è½‰å›é™£åˆ—æˆ–é¡¯ç¤ºéŒ¯èª¤
                const ingredientsList = Array.isArray(r.ingredients) ? r.ingredients : (r.ingredients ? [r.ingredients] : []);
                ingredientsList.forEach(i => { 
                    const li = document.createElement('li'); 
                    li.innerText = i; 
                    ingEl.appendChild(li); 
                });

                const stepContainer = document.getElementById('detail-instructions');
                stepContainer.innerHTML = ''; 
                stepContainer.className = "space-y-3"; 

                // åŠ å…¥ã€Œé–‹å§‹çƒ¹é£ªã€æŒ‰éˆ•
                const startCookBtn = document.createElement('button');
                startCookBtn.className = "w-full bg-brand-500 text-white font-bold py-3 rounded-xl shadow-lg mb-4 flex items-center justify-center gap-2 active:scale-95 transition-transform";
                startCookBtn.innerHTML = '<i class="fa-solid fa-fire-burner"></i> é–‹å§‹æ²‰æµ¸å¼çƒ¹é£ª';
                startCookBtn.onclick = () => app.startCooking(r.id);
                stepContainer.appendChild(startCookBtn);

                if (r.instructions) {
                    // âœ… ä¿®æ­£ï¼šæ›´å¼·å¤§çš„æ­¥é©Ÿè§£æé‚è¼¯
                    let raw = r.instructions;
                    // 1. å…ˆå°‡ \\n (å­—ä¸²çš„æ›è¡Œ) è½‰ç‚ºçœŸæ­£çš„ \n
                    raw = raw.replace(/\\n/g, '\n');
                    
                    // 2. å¦‚æœå…§å®¹å®Œå…¨æ²’æœ‰æ›è¡Œï¼Œä½†æœ‰ "1. ", "2. " é€™ç¨®çµæ§‹ï¼Œæ‰‹å‹•è£œæ›è¡Œ
                    if (!raw.includes('\n') && raw.match(/\d+\./)) {
                        raw = raw.replace(/(\d+\.)/g, '\n$1');
                    }
                    
                    // 3. åˆ‡å‰²ä¸¦éæ¿¾ç©ºè¡Œ
                    let steps = raw.split('\n').map(s => s.trim()).filter(s => s.length > 0);

                    steps.forEach((step, idx) => {
                        const stepDiv = document.createElement('div');
                        stepDiv.className = "flex gap-3 items-start p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-gray-100 transition-colors group";
                        stepDiv.onclick = function() {
                            const cb = this.querySelector('input');
                            const txt = this.querySelector('p');
                            cb.checked = !cb.checked;
                            if(cb.checked) {
                                txt.classList.add('line-through', 'text-gray-300');
                                this.classList.replace('bg-gray-50', 'bg-green-50');
                            } else {
                                txt.classList.remove('line-through', 'text-gray-300');
                                this.classList.replace('bg-green-50', 'bg-gray-50');
                            }
                        };
                        stepDiv.innerHTML = `
                            <div class="mt-0.5 relative"><input type="checkbox" class="w-5 h-5 rounded border-gray-300 text-brand-500 focus:ring-brand-400 pointer-events-none"></div>
                            <p class="text-sm text-gray-700 leading-6 select-none flex-1">${step}</p>
                        `;
                        stepContainer.appendChild(stepDiv);
                    });
                } else {
                    stepContainer.innerHTML += '<div class="text-gray-400 text-center py-4">æš«ç„¡æ­¥é©Ÿè³‡æ–™</div>';
                }

                document.getElementById('modal-detail').classList.remove('hidden');
            },
            // 3. æ›¿æ›ï¼šfilterRecipes (æ”¯æ´ 'fav' ç¯©é¸)
            filterRecipes: (tag) => {
                let list;
                if (tag === 'all') {
                    list = recipes;
                } else if (tag === 'fav') {
                    // ç¯©é¸å‡ºæ”¶è—çš„èœè‰²
                    list = recipes.filter(r => r.favorite);
                } else {
                    list = recipes.filter(r => r.tags.some(t => t.includes(tag)));
                }
                app.renderSelectorList(list);
            },
            openSelector: (d) => {
                app.state.selectedDay = d;
                app.renderSelectorList(recipes);
                document.getElementById('modal-selector').classList.remove('hidden');
            },
            renderSelectorList: (list) => {
                const el = document.getElementById('selector-list');
                el.innerHTML = '';
                list.forEach(r => {
                    const d = document.createElement('div');
                    d.className = "flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 cursor-pointer";
                    d.onclick = () => {
                        app.state.plan[app.state.selectedDay] = r.id;
                        localStorage.setItem('bento_plan', JSON.stringify(app.state.plan));
                        app.renderPlanner();
                        app.closeModal('modal-selector');
                    };
                    d.innerHTML = `
                        <div class="w-12 h-12 bg-brand-50 rounded-lg flex items-center justify-center text-brand-400 shrink-0"><i class="fa-solid fa-utensils"></i></div>
                        <div><div class="text-sm font-bold text-gray-800">${r.name}</div><div class="text-xs text-gray-400">${r.cal} Kcal</div></div>
                    `;
                    el.appendChild(d);
                });
            },
            openDetailById: (id) => app.openDetail(recipes.find(r => r.id === id)),
            // --- æ–°å¢ï¼šä¸€éµéæ¿¾å¸¸å‚™å“ ---
            filterStaples: () => {
                // å®šç¾©å¸¸å‚™å“é—œéµå­—
                const staples = ['æ²¹', 'é¹½', 'ç³–', 'é†¬æ²¹', 'é†‹', 'èƒ¡æ¤’', 'ç±³é…’', 'å¤ªç™½ç²‰', 'è’œ', 'è–‘', 'è”¥', 'æ°´', 'é¦™æ–™', 'èŠéº»', 'æ—¥å¼é†¬æ²¹(ä½éˆ‰)'];
                let count = 0;
                
                // å–å¾—æ‰€æœ‰éœ€è¦çš„é£Ÿæåç¨±
                const needed = app.getAggregatedIngredients(); // å‘¼å«æ—¢æœ‰çš„ helper
                
                needed.forEach(name => {
                    // å¦‚æœé£Ÿæåç¨±åŒ…å«å¸¸å‚™å“é—œéµå­— (ä¾‹å¦‚ "æ©„æ¬–æ²¹" åŒ…å« "æ²¹")
                    if (staples.some(s => name.includes(s))) {
                        // å°‡å…¶è¨­ç‚ºå·²è³¼è²· (true)
                        if (!app.state.shopping[name]) {
                            app.state.shopping[name] = true;
                            count++;
                        }
                    }
                });
                
                // å­˜æª”ä¸¦é‡ç¹ª
                localStorage.setItem('bento_shopping', JSON.stringify(app.state.shopping));
                app.renderShopping();
                
                if(count > 0) app.showToast(`å·²è‡ªå‹•éš±è— ${count} é …å¸¸å‚™èª¿å‘³å“`);
                else app.showToast('æ²’æœ‰ç™¼ç¾æœªå‹¾é¸çš„å¸¸å‚™å“');
            },

            closeModal: (id) => document.getElementById(id).classList.add('hidden'),
            showToast: (msg) => {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 2000);
            },
            // --- è«‹æ–°å¢æ­¤å‡½å¼åˆ° app ç‰©ä»¶ä¸­ ---
            showModal: (msg, title = "æç¤º", type = "confirm") => {
                return new Promise((resolve) => {
                    const modal = document.getElementById('modal-general');
                    const titleEl = document.getElementById('modal-title');
                    const msgEl = document.getElementById('modal-msg');
                    const btnConfirm = document.getElementById('modal-btn-confirm');
                    const btnCancel = document.getElementById('modal-btn-cancel');
                    const iconEl = document.getElementById('modal-icon');
                    const iconBg = document.getElementById('modal-icon-bg');

                    // è¨­å®šæ–‡å­—
                    titleEl.innerText = title;
                    msgEl.innerText = msg;
                    modal.classList.remove('hidden');

                    // æ ¹æ“šé¡å‹è¨­å®šæ¨£å¼ (confirm: é›™æŒ‰éˆ•, alert: å–®æŒ‰éˆ•, error: ç´…è‰²å–®æŒ‰éˆ•)
                    if (type === 'alert' || type === 'error') {
                        btnCancel.classList.add('hidden');
                        btnConfirm.innerText = "çŸ¥é“äº†";
                        // å–®æŒ‰éˆ•æ™‚å¯¬åº¦å…¨æ»¿
                        btnConfirm.className = "w-full bg-brand-500 text-white font-bold py-3.5 rounded-2xl shadow-float hover:bg-brand-600 transition active:scale-95";
                    } else {
                        btnCancel.classList.remove('hidden');
                        btnConfirm.innerText = "ç¢ºå®š";
                        // é›™æŒ‰éˆ•æ™‚å„ä½”ä¸€åŠ
                        btnConfirm.className = "flex-1 bg-brand-500 text-white font-bold py-3.5 rounded-2xl shadow-float hover:bg-brand-600 transition active:scale-95";
                    }
                    
                    // è¨­å®šåœ–ç¤ºèˆ‡é¡è‰²
                    if (type === 'error') {
                        iconEl.className = "fa-solid fa-circle-exclamation";
                        iconBg.className = "w-16 h-16 rounded-full bg-red-50 text-red-500 flex items-center justify-center mb-4 text-2xl shadow-sm";
                        if(type === 'error') btnConfirm.classList.replace('bg-brand-500', 'bg-red-500'); // æŒ‰éˆ•è®Šç´…
                    } else if (type === 'confirm') {
                        iconEl.className = "fa-solid fa-circle-question";
                        iconBg.className = "w-16 h-16 rounded-full bg-brand-50 text-brand-500 flex items-center justify-center mb-4 text-2xl shadow-sm";
                    } else {
                        iconEl.className = "fa-solid fa-circle-info";
                        iconBg.className = "w-16 h-16 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center mb-4 text-2xl shadow-sm";
                    }

                    // äº‹ä»¶è™•ç† (ä½¿ç”¨ Promise resolve å›å‚³ true/false)
                    const close = (val) => {
                        modal.classList.add('hidden');
                        // é‚„åŸæŒ‰éˆ•æ¨£å¼ (é¿å…ä¸‹æ¬¡é–‹å•Ÿæ®˜ç•™ç´…è‰²)
                        btnConfirm.classList.replace('bg-red-500', 'bg-brand-500'); 
                        resolve(val);
                    };

                    // è¦†è“‹èˆŠçš„ onclickï¼Œé¿å…é‡è¤‡ç¶å®š
                    btnConfirm.onclick = () => close(true);
                    btnCancel.onclick = () => close(false);
                });
            },
            exportData: () => {
                const data = {
                    user: localStorage.getItem('bento_user'),
                    plan: localStorage.getItem('bento_plan'),
                    shopping: localStorage.getItem('bento_shopping'),
                    recipes: localStorage.getItem('bento_recipes'),
                    history: localStorage.getItem('bento_history')
                };
                const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bento_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            },
            importData: (input) => {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async(e) => {
                    try {
                        const d = JSON.parse(e.target.result);
                        if(d.user) localStorage.setItem('bento_user', d.user);
                        if(d.plan) localStorage.setItem('bento_plan', d.plan);
                        if(d.shopping) localStorage.setItem('bento_shopping', d.shopping);
                        if(d.recipes) localStorage.setItem('bento_recipes', d.recipes);
                        if(d.history) localStorage.setItem('bento_history', d.history);
                        app.showToast("âœ… è³‡æ–™åŒ¯å…¥æˆåŠŸï¼");
                        setTimeout(() => location.reload(), 1000);
                    } catch(err) { await app.showModal("æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è®€å–ã€‚", "åŒ¯å…¥å¤±æ•—", "error"); }
                };
                reader.readAsText(file);
            },
            resetData: async () => { // âš ï¸ è¨˜å¾—åŠ  async
                // âœ… ä¿®æ”¹è™•ï¼šä½¿ç”¨ç´…è‰²çš„ error é¡å‹å½ˆçª—è­¦å‘Š
                if(await app.showModal("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚", "å±éšªæ“ä½œ", "error")) {
                    localStorage.clear();
                    location.reload();
                }
            },
        };

        window.addEventListener('DOMContentLoaded', app.init);
        // âœ… å„ªåŒ–å¾Œçš„ Service Worker è¨»å†Š
        if ('serviceWorker' in navigator) {
            // åªåœ¨ http æˆ– https å”è­°ä¸‹è¨»å†Š (é¿é–‹ file:// çš„å ±éŒ¯)
            if (window.location.protocol.startsWith('http')) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('SW registered: ', reg.scope))
                        .catch(err => console.log('SW reg failed: ', err));
                });
            }
        }
        // æ”¾åœ¨ <script> çš„æœ€å¾Œé¢ï¼Œç›£è½è¢å¹•å¯è¦‹åº¦è®ŠåŒ–
        document.addEventListener('visibilitychange', async () => {
            // å¦‚æœæ­£åœ¨çƒ¹é£ªæ¨¡å¼ (modal-cooking æ²’è¢«éš±è—) ä¸” å›åˆ°ç•«é¢ (visible)
            const cookingModal = document.getElementById('modal-cooking');
            if (cookingModal && !cookingModal.classList.contains('hidden') && document.visibilityState === 'visible') {
                try {
                    if ('wakeLock' in navigator) {
                        app.wakeLock = await navigator.wakeLock.request('screen');
                        console.log('è¢å¹•æ†äº®å·²è‡ªå‹•æ¢å¾©');
                    }
                } catch (err) {
                    console.log('ç„¡æ³•æ¢å¾© Wake Lock:', err);
                }
            }
        });
    </script>
</body>
</html>